<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control Center - HQ Completo</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Supabase CDN - cargado desde el head para garantizar disponibilidad -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
    }

    .header {
      position: sticky;
      top: 0;
      z-index: 50;
      border-bottom: 1px solid #1F1F1F;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      padding: 16px 20px;
    }

    .header-title {
      font-size: 18px;
      font-weight: 600;
    }

    .header-subtitle {
      font-size: 12px;
      color: #888;
      margin-top: 2px;
    }

    .nav {
      display: flex;
      gap: 8px;
      padding: 12px 20px;
      overflow-x: auto;
      border-bottom: 1px solid #1F1F1F;
    }

    .nav::-webkit-scrollbar {
      display: none;
    }

    .nav-btn {
      background: transparent;
      border: none;
      color: #888;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.15s;
    }

    .nav-btn:hover,
    .nav-btn.active {
      background: #1A1A1A;
      color: #fff;
    }

    .content {
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #666;
    }

    .btn-add {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: #1A1A1A;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
    }

    .btn-add:hover {
      background: #252525;
    }

    .btn-back {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: #1A1A1A;
      border: none;
      border-radius: 8px;
      color: #888;
      font-size: 13px;
      cursor: pointer;
      margin-bottom: 20px;
      transition: all 0.15s;
    }

    .btn-back:hover {
      background: #252525;
      color: #fff;
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    .grid-2 {
      grid-template-columns: 1fr;
    }

    .grid-3 {
      grid-template-columns: 1fr;
    }

    @media (min-width: 600px) {
      .grid-2 {
        grid-template-columns: repeat(2, 1fr);
      }

      .grid-3 {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .card {
      background: #0D0D0D;
      border: 1px solid #1A1A1A;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.2s;
    }

    .card-clickable {
      cursor: pointer;
    }

    .card-clickable:hover {
      border-color: #333;
      transform: translateY(-2px);
    }

    .stat-card {
      text-align: center;
    }

    .stat-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .stat-label {
      font-size: 13px;
      color: #888;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
    }

    .company-logo,
    .brand-logo {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      background: #1A1A1A;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .brand-logo {
      width: 50px;
      height: 50px;
      font-size: 20px;
    }

    .info-section {
      background: #0D0D0D;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .info-section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #1A1A1A;
      font-size: 13px;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: #888;
    }

    .info-value {
      color: #fff;
      text-align: right;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
    }

    .status-activa {
      background: rgba(74, 222, 128, 0.15);
      color: #4ADE80;
    }

    .status-desarrollo {
      background: rgba(251, 191, 36, 0.15);
      color: #FBBF24;
    }

    .status-concepto {
      background: rgba(167, 139, 250, 0.15);
      color: #A78BFA;
    }

    .status-pausa {
      background: rgba(248, 113, 113, 0.15);
      color: #F87171;
    }

    .cost-badge {
      padding: 6px 12px;
      background: #1A1A1A;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      color: #4ADE80;
    }

    .service-item {
      background: #1A1A1A;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .service-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .service-name {
      font-size: 14px;
      font-weight: 500;
    }

    .service-meta {
      font-size: 12px;
      color: #888;
    }

    .renewal-badge {
      padding: 4px 8px;
      background: rgba(251, 191, 36, 0.15);
      color: #FBBF24;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
    }

    .tag {
      display: inline-block;
      padding: 4px 10px;
      background: #1A1A1A;
      border-radius: 6px;
      font-size: 11px;
      color: #888;
      margin-right: 6px;
      margin-bottom: 6px;
    }

    .alert-box {
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .alert-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #FBBF24;
      margin-bottom: 12px;
    }

    .alert-item {
      font-size: 13px;
      color: #C8C8C8;
      padding: 8px 0;
      border-bottom: 1px solid rgba(251, 191, 36, 0.1);
    }

    .alert-item:last-child {
      border-bottom: none;
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #0D0D0D;
      border: 1px solid #1A1A1A;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: #888;
      cursor: pointer;
      padding: 4px;
      font-size: 24px;
      line-height: 1;
    }

    .modal-close:hover {
      color: #fff;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      color: #888;
      margin-bottom: 6px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 10px 12px;
      background: #1A1A1A;
      border: 1px solid #252525;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      font-family: inherit;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #fff;
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-actions {
      display: flex;
      gap: 8px;
      margin-top: 24px;
    }

    .btn-cancel,
    .btn-submit {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-cancel {
      background: #1A1A1A;
      color: #fff;
    }

    .btn-cancel:hover {
      background: #252525;
    }

    .btn-submit {
      background: #fff;
      color: #000;
    }

    .btn-submit:hover {
      background: #e5e5e5;
    }

    .dynamic-field {
      background: #1A1A1A;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      position: relative;
    }

    .dynamic-field-remove {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      padding: 4px;
    }

    .dynamic-field-remove:hover {
      color: #F87171;
    }

    .dynamic-field .form-group {
      margin-bottom: 8px;
    }

    .dynamic-field .form-group:last-child {
      margin-bottom: 0;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .tag-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      margin-right: 6px;
      margin-bottom: 6px;
    }

    .tag-item button {
      background: transparent;
      border: none;
      color: currentColor;
      opacity: 0.7;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
      margin-left: 4px;
    }

    .tag-item button:hover {
      opacity: 1;
    }

    .tag-input-wrapper {
      background: #1A1A1A;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .tag-input-wrapper input {
      flex: 1;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 13px;
      outline: none;
    }

    .tag-input-wrapper button {
      padding: 6px 12px;
      background: #252525;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
    }

    .tag-input-wrapper button:hover {
      background: #333;
    }

    /* ============================================ */
    /* RESPONSIVE DESIGN - MOBILE FIRST */
    /* ============================================ */
    
    /* Mobile: Ocultar b√∫squeda y ajustar header */
    @media (max-width: 768px) {
      .header {
        padding: 12px 16px;
      }

      .header-title {
        font-size: 16px;
      }

      .header-subtitle {
        font-size: 11px;
      }

      /* Ocultar b√∫squeda en m√≥vil */
      #global-search {
        display: none !important;
      }

      /* Ajustar botones del header */
      .header button {
        padding: 8px 12px !important;
        font-size: 12px !important;
      }

      .header button span {
        display: none; /* Ocultar texto, solo iconos */
      }

      /* Navegaci√≥n responsive */
      .nav {
        padding: 8px 12px;
        gap: 4px;
      }

      .nav-btn {
        padding: 8px 12px;
        font-size: 12px;
      }

      /* Contenido */
      .content {
        padding: 16px 12px;
      }

      /* Cards m√°s compactas */
      .card {
        padding: 16px;
      }

      /* Grids en m√≥vil siempre 1 columna */
      .grid-2,
      .grid-3 {
        grid-template-columns: 1fr !important;
      }

      /* Modales en m√≥vil */
      .modal-content {
        width: 95% !important;
        max-width: 95% !important;
        margin: 20px auto !important;
        max-height: 90vh !important;
        overflow-y: auto !important;
      }

      .modal-header {
        padding: 16px !important;
      }

      .modal-title {
        font-size: 18px !important;
      }

      /* Formularios */
      .form-group {
        margin-bottom: 16px !important;
      }

      .form-input,
      .form-select,
      .form-textarea {
        font-size: 16px !important; /* Evita zoom en iOS */
      }

      /* Botones m√°s grandes en m√≥vil */
      .btn-add,
      .btn-submit,
      .btn-cancel {
        padding: 12px 16px !important;
        font-size: 14px !important;
      }

      /* Stats cards m√°s peque√±as */
      .stat-value {
        font-size: 28px !important;
      }

      .stat-label {
        font-size: 12px !important;
      }

      /* Logos m√°s peque√±os */
      .company-logo,
      .brand-logo {
        width: 50px !important;
        height: 50px !important;
        font-size: 20px !important;
      }

      /* Ajustar secciones */
      .section-header {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 12px !important;
      }

      .section-title {
        font-size: 20px !important;
      }

      /* Alert box */
      .alert-box {
        padding: 12px !important;
      }

      .alert-title {
        font-size: 13px !important;
      }

      .alert-item {
        font-size: 12px !important;
      }
    }

    /* Tablet y pantallas medianas */
    @media (min-width: 769px) and (max-width: 1024px) {
      .content {
        padding: 20px 16px;
      }

      .grid-3 {
        grid-template-columns: repeat(2, 1fr) !important;
      }

      #global-search {
        width: 250px !important;
      }
    }

    /* Desktop grande */
    @media (min-width: 1025px) {
      .content {
        max-width: 1400px;
      }
    }

    /* Fix para iOS Safari */
    @supports (-webkit-touch-callout: none) {
      body {
        min-height: -webkit-fill-available;
      }
    }
  </style>
</head>

<body>
  <div id="app">
    <!-- Contenido de la app se cargar√° aqu√≠ -->
  </div>


  <script>
    // ============================================
    // CONFIGURACI√ìN DE SUPABASE
    // ============================================

    // Configuraci√≥n de Supabase
    const SUPABASE_CONFIG = {
      enabled: true, // ‚úÖ Supabase configurado y habilitado
      url: 'https://fbhdpwedkdbyectmieeh.supabase.co', // Tu URL de Supabase
      anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZiaGRwd2Vka2RieWVjdG1pZWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2OTgwMzYsImV4cCI6MjA4NTI3NDAzNn0.bCwnZNNM4o1N_WC-8M0t_1eaID_pxszgRrZNflxBaLk', // Tu clave an√≥nima de Supabase
      realTimeSync: true // Sincronizaci√≥n en tiempo real
    };

    let supabase = null;
    let supabaseSubscriptions = [];

    // ============================================
    // VARIABLES GLOBALES DE DATOS
    // ============================================
    let companies = [];
    let brands = [];
    let tasks = [];
    let subscriptions = [];
    let credentials = [];
    let documents = [];
    let memoriaContable = [];
    let notas = [];

    // ============================================
    // AUTENTICACI√ìN
    // ============================================
    const authConfig = {
      username: 'silenthub_admin',
      password: 'SH2026_SecureAccess!' // üîí CAMBIAR ANTES DE PRODUCCI√ìN
    };

    let isAuthenticated = false;

    // ============================================
    // FUNCI√ìN DE AUTENTICACI√ìN (MINIMALISTA)
    // ============================================
    function checkAuth() {
      const savedAuth = localStorage.getItem('controlCenterAuth');
      
      if (savedAuth) {
        try {
          const authData = JSON.parse(savedAuth);
          const now = new Date().getTime();
          // Sesi√≥n v√°lida por 24 horas
          if (authData.timestamp && (now - authData.timestamp) < 24 * 60 * 60 * 1000) {
            isAuthenticated = true;
            showMainApp();
            return;
          } else {
            // Sesi√≥n expirada
            localStorage.removeItem('controlCenterAuth');
          }
        } catch(e) {
          // Datos corruptos
          localStorage.removeItem('controlCenterAuth');
        }
      }
      
      // No autenticado o sesi√≥n inv√°lida: mostrar login
      showLoginScreen();
    }

    function showLoginScreen() {
      // Obtener contenedor de la app
      const app = document.getElementById('app');
      if (!app) return;
      
      // Inyectar formulario de login
      app.innerHTML = `
        <div style="
          display: flex;
          justify-content: center;
          align-items: center;
          min-height: 100vh;
          background: linear-gradient(135deg, #0F0F0F 0%, #1A1A1A 100%);
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        ">
          <div style="
            background: #1A1A1A;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border: 1px solid #333;
            width: 100%;
            max-width: 400px;
            text-align: center;
          ">
            <div style="
              width: 80px;
              height: 80px;
              background: linear-gradient(135deg, #4ADE80 0%, #22C55E 100%);
              border-radius: 20px;
              display: flex;
              align-items: center;
              justify-content: center;
              margin: 0 auto 24px;
              font-size: 32px;
              font-weight: 700;
              color: white;
            ">CC</div>
            
            <h1 style="
              color: white;
              font-size: 28px;
              font-weight: 700;
              margin: 0 0 8px 0;
            ">Control Center</h1>
            
            <p style="
              color: #888;
              font-size: 14px;
              margin: 0 0 32px 0;
            ">Acceso seguro al sistema</p>
            
            <form id="login-form" style="text-align: left;">
              <div style="margin-bottom: 20px;">
                <label style="
                  display: block;
                  color: #C8C8C8;
                  font-size: 13px;
                  font-weight: 500;
                  margin-bottom: 6px;
                ">Usuario</label>
                <input 
                  type="text" 
                  id="username" 
                  required
                  style="
                    width: 100%;
                    padding: 12px 16px;
                    background: #0D0D0D;
                    border: 1px solid #333;
                    border-radius: 8px;
                    color: white;
                    font-size: 14px;
                    box-sizing: border-box;
                  "
                  placeholder="Ingresa tu usuario"
                />
              </div>
              
              <div style="margin-bottom: 24px;">
                <label style="
                  display: block;
                  color: #C8C8C8;
                  font-size: 13px;
                  font-weight: 500;
                  margin-bottom: 6px;
                ">Contrase√±a</label>
                <input 
                  type="password" 
                  id="password" 
                  required
                  style="
                    width: 100%;
                    padding: 12px 16px;
                    background: #0D0D0D;
                    border: 1px solid #333;
                    border-radius: 8px;
                    color: white;
                    font-size: 14px;
                    box-sizing: border-box;
                  "
                  placeholder="Ingresa tu contrase√±a"
                />
              </div>
              
              <button 
                type="submit"
                style="
                  width: 100%;
                  padding: 14px;
                  background: linear-gradient(135deg, #4ADE80 0%, #22C55E 100%);
                  border: none;
                  border-radius: 8px;
                  color: white;
                  font-size: 14px;
                  font-weight: 600;
                  cursor: pointer;
                  transition: all 0.2s;
                "
                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(74, 222, 128, 0.3)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
              >
                Iniciar Sesi√≥n
              </button>
            </form>
            
            <div id="login-error" style="
              color: #F87171;
              font-size: 13px;
              margin-top: 16px;
              display: none;
            "></div>
          </div>
        </div>
      `;

      document.getElementById('login-form').addEventListener('submit', handleLogin);
    }

    function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('login-error');

      if (username === authConfig.username && password === authConfig.password) {
        // Guardar autenticaci√≥n
        const authData = {
          authenticated: true,
          timestamp: new Date().getTime()
        };
        localStorage.setItem('controlCenterAuth', JSON.stringify(authData));

        isAuthenticated = true;
        showMainApp();
      } else {
        errorDiv.textContent = 'Usuario o contrase√±a incorrectos';
        errorDiv.style.display = 'block';

        // Limpiar error despu√©s de 3 segundos
        setTimeout(() => {
          errorDiv.style.display = 'none';
        }, 3000);
      }
    }

    function logout() {
      localStorage.removeItem('controlCenterAuth');
      isAuthenticated = false;
      location.reload();
    }

    // ============================================
    // INICIALIZACI√ìN DE SUPABASE
    // ============================================
    async function initializeSupabase() {
      try {
        // Crear cliente de Supabase
        supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);

        console.log('‚úÖ Supabase inicializado correctamente');
        console.log('üìç URL:', SUPABASE_CONFIG.url);

        // Cargar datos desde Supabase
        await loadFromSupabase();

        // Si hay realTimeSync habilitado, suscribirse a cambios
        if (SUPABASE_CONFIG.realTimeSync) {
          subscribeToRealtimeChanges();
        }

        return true;
      } catch (error) {
        console.error('‚ùå Error inicializando Supabase:', error);
        return false;
      }
    }

    // Cargar todos los datos desde Supabase
    async function loadFromSupabase() {
      if (!supabase) return;

      try {
        console.log('üì• Cargando datos desde Supabase...');

        // Primero cargar datos locales como respaldo
        const localCompanies = JSON.parse(localStorage.getItem('companies') || '[]');
        const localBrands = JSON.parse(localStorage.getItem('brands') || '[]');
        const localTasks = JSON.parse(localStorage.getItem('tasks') || '[]');
        const localSubscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');
        const localCredentials = JSON.parse(localStorage.getItem('credentials') || '[]');

        // Cargar empresas
        const { data: companiesData, error: companiesError } = await supabase
          .from('companies')
          .select('*')
          .order('created_at', { ascending: false });

        if (companiesError) {
          console.warn('‚ö†Ô∏è Error cargando empresas desde Supabase:', companiesError);
          companies = localCompanies;
        } else if (companiesData) {
          companies = companiesData.map(c => ({
            ...c,
            tags: c.tags || [],
            bankAccounts: c.bank_accounts || [],
            emails: c.emails || [],
            socialMedia: c.social_media || []
          }));
          // Si Supabase est√° vac√≠o pero localStorage tiene datos, usar localStorage
          if (companies.length === 0 && localCompanies.length > 0) {
            console.log('‚ö†Ô∏è Supabase vac√≠o, usando datos de localStorage para empresas');
            companies = localCompanies;
          }
        }

        // Cargar marcas
        const { data: brandsData, error: brandsError } = await supabase
          .from('brands')
          .select('*')
          .order('created_at', { ascending: false });

        if (brandsError) {
          console.warn('‚ö†Ô∏è Error cargando marcas desde Supabase:', brandsError);
          brands = localBrands;
        } else if (brandsData) {
          brands = brandsData.map(b => ({
            ...b,
            companyId: b.company_id,
            tags: b.tags || [],
            emails: b.emails || [],
            socialMedia: b.social_media || []
          }));
          // Si Supabase est√° vac√≠o pero localStorage tiene datos, usar localStorage
          if (brands.length === 0 && localBrands.length > 0) {
            console.log('‚ö†Ô∏è Supabase vac√≠o, usando datos de localStorage para marcas');
            brands = localBrands;
            // Sincronizar a Supabase
            console.log('üîÑ Sincronizando marcas locales a Supabase...');
            for (const brand of brands) {
              await saveToSupabase(brand, 'brands', 'brand');
            }
          }
        }

        // Cargar tareas
        const { data: tasksData, error: tasksError } = await supabase
          .from('tasks')
          .select('*')
          .order('created_at', { ascending: false });

        if (tasksError) {
          console.warn('‚ö†Ô∏è Error cargando tareas desde Supabase:', tasksError);
          tasks = localTasks;
        } else if (tasksData) {
          tasks = tasksData;
          if (tasks.length === 0 && localTasks.length > 0) {
            console.log('‚ö†Ô∏è Supabase vac√≠o, usando datos de localStorage para tareas');
            tasks = localTasks;
          }
        }

        // Cargar suscripciones
        const { data: subsData, error: subsError } = await supabase
          .from('subscriptions')
          .select('*')
          .order('created_at', { ascending: false });

        if (subsError) {
          console.warn('‚ö†Ô∏è Error cargando suscripciones desde Supabase:', subsError);
          subscriptions = localSubscriptions;
        } else if (subsData) {
          subscriptions = subsData;
          if (subscriptions.length === 0 && localSubscriptions.length > 0) {
            console.log('‚ö†Ô∏è Supabase vac√≠o, usando datos de localStorage para suscripciones');
            subscriptions = localSubscriptions;
          }
        }

        // Cargar credenciales
        const { data: credsData, error: credsError } = await supabase
          .from('credentials')
          .select('*')
          .order('created_at', { ascending: false });

        if (credsError) {
          console.warn('‚ö†Ô∏è Error cargando credenciales desde Supabase:', credsError);
          credentials = localCredentials;
        } else if (credsData) {
          credentials = credsData;
          if (credentials.length === 0 && localCredentials.length > 0) {
            console.log('‚ö†Ô∏è Supabase vac√≠o, usando datos de localStorage para credenciales');
            credentials = localCredentials;
          }
        }

        console.log(`‚úÖ Datos cargados: ${companies.length} empresas, ${brands.length} marcas, ${tasks.length} tareas`);
        console.log(`üìä Supabase: ${companiesData?.length || 0} empresas, ${brandsData?.length || 0} marcas en la nube`);
        console.log(`üíæ localStorage: ${localCompanies.length} empresas, ${localBrands.length} marcas locales`);

      } catch (error) {
        console.error('‚ùå Error cargando datos desde Supabase:', error);
        // En caso de error, cargar desde localStorage
        companies = JSON.parse(localStorage.getItem('companies') || '[]');
        brands = JSON.parse(localStorage.getItem('brands') || '[]');
        tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
        subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');
        credentials = JSON.parse(localStorage.getItem('credentials') || '[]');
        console.log('‚ö†Ô∏è Usando datos de localStorage por error en Supabase');
      }
    }

    // Suscribirse a cambios en tiempo real
    function subscribeToRealtimeChanges() {
      if (!supabase) return;

      console.log('üîî Suscrito a cambios en tiempo real');

      // Suscribirse a cambios en companies
      const companiesChannel = supabase
        .channel('companies-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'companies' }, async () => {
          console.log('üîÑ Cambio detectado en companies, recargando...');
          await loadFromSupabase();
          if (currentView === 'companies') renderCompanies();
        })
        .subscribe();

      supabaseSubscriptions.push(companiesChannel);

      // Suscribirse a cambios en brands
      const brandsChannel = supabase
        .channel('brands-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'brands' }, async () => {
          console.log('üîÑ Cambio detectado en brands, recargando...');
          await loadFromSupabase();
          if (currentView === 'brands') renderBrands();
        })
        .subscribe();

      supabaseSubscriptions.push(brandsChannel);

      // Similar para tasks, subscriptions, credentials
      const tasksChannel = supabase
        .channel('tasks-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, async () => {
          console.log('üîÑ Cambio detectado en tasks, recargando...');
          await loadFromSupabase();
          if (currentView === 'tasks') renderTasks();
        })
        .subscribe();

      supabaseSubscriptions.push(tasksChannel);
    }

    function showMainApp() {
      // Obtener contenedor de la app
      const app = document.getElementById('app');
      if (!app) return;
      
      // Inyectar HTML de la aplicaci√≥n
      app.innerHTML = getMainAppHTML();
      
      // Inicializar la aplicaci√≥n
      document.body.classList.add('authenticated');
      initializeApp();

      // Inicializar Supabase si est√° habilitado (script ya cargado desde el head)
      if (SUPABASE_CONFIG.enabled && SUPABASE_CONFIG.url && SUPABASE_CONFIG.anonKey) {
        // Verificar que Supabase est√© disponible
        if (typeof window.supabase === 'object' && window.supabase.createClient) {
          console.log('üì¶ Supabase disponible, inicializando...');
          initializeSupabase();
        } else {
          console.error('‚ùå Supabase no disponible, usando localStorage');
          console.log('üîç window.supabase:', window.supabase);
        }
      }
    }

    function getMainAppHTML() {
      return `
        <header class="header">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
              <h1 class="header-title" id="center-name">FGD VII ‚Äî Control Center</h1>
              <p class="header-subtitle" id="center-subtitle">Empresas ¬∑ Marcas ¬∑ Suscripciones ¬∑ Credenciales</p>
            </div>
            <div style="position: relative; margin-right: 16px;">
              <input 
                type="text" 
                id="global-search" 
                placeholder="üîç Buscar..."
                style="padding: 10px 16px; background: #1A1A1A; border: 1px solid #252525; border-radius: 8px; color: #fff; font-size: 14px; width: 300px;"
                onkeyup="globalSearch(this.value)"
              >
              <div id="search-results" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: #0D0D0D; border: 1px solid #1A1A1A; border-radius: 8px; width: 400px; max-height: 400px; overflow-y: auto; z-index: 100;"></div>
            </div>
            <div style="display: flex; gap: 12px;">
              <button onclick="openModal('config')" style="padding: 10px 16px; background: #1A1A1A; border: 1px solid #252525; border-radius: 8px; color: #fff; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; white-space: nowrap;">
                ‚öôÔ∏è Mi perfil
              </button>
              <button onclick="logout()" style="padding: 10px 16px; background: #1A1A1A; border: 1px solid #252525; border-radius: 8px; color: #fff; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; white-space: nowrap;">
                üö™ Salir
              </button>
            </div>
          </div>
        </header>

        <nav class="nav">
          <button class="nav-btn active" data-view="dashboard">Dashboard</button>
          <button class="nav-btn" data-view="tareas">Tareas</button>
          <button class="nav-btn" data-view="empresas">Empresas</button>
          <button class="nav-btn" data-view="marcas">Marcas</button>
          <button class="nav-btn" data-view="memoria">Memoria Contable</button>
          <button class="nav-btn" data-view="documentos">Documentos</button>
          <button class="nav-btn" data-view="suscripciones">Suscripciones</button>
          <button class="nav-btn" data-view="credenciales">Credenciales</button>
        </nav>

        <main class="content">

          <!-- DASHBOARD -->
          <div id="dashboard" class="view active">
            
            <!-- Alertas de renovaci√≥n -->
            <div class="alert-box">
              <div class="alert-title">
                ‚ö†Ô∏è Pr√≥ximas renovaciones (este mes)
              </div>
              <div class="alert-item">
                <strong>Google Workspace</strong> (5‚Ç¨) - Renueva d√≠a 18
              </div>
              <div class="alert-item">
                <strong>fliia.app</strong> - Renueva en 45 d√≠as
              </div>
            </div>

            <div class="grid grid-3">
              <div class="card stat-card">
                <div class="stat-icon">üìã</div>
                <div class="stat-label">Tareas de hoy</div>
                <div class="stat-value" id="tasks-today">0</div>
              </div>
              <div class="card stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-label">Completadas</div>
                <div class="stat-value" id="tasks-completed">0</div>
              </div>
              <div class="card stat-card">
                <div class="stat-icon">‚è∞</div>
                <div class="stat-label">Pendientes</div>
                <div class="stat-value" id="tasks-pending">0</div>
              </div>
            </div>

            <div style="margin-top: 24px;">
              <div class="section-title" style="margin-bottom: 16px;">Accesos r√°pidos</div>
              <div class="grid grid-3">
                <div class="card card-clickable" onclick="document.querySelector('[data-view=\\'empresas\\']').click()">
                  <div style="font-size: 32px; margin-bottom: 8px;">üè¢</div>
                  <div style="font-size: 14px; font-weight: 500;">Ver Empresas</div>
                  <div style="font-size: 12px; color: #888;">Gestionar empresas</div>
                </div>
                <div class="card card-clickable" onclick="document.querySelector('[data-view=\\'marcas\\']').click()">
                  <div style="font-size: 32px; margin-bottom: 8px;">üè∑</div>
                  <div style="font-size: 14px; font-weight: 500;">Ver Marcas</div>
                  <div style="font-size: 12px; color: #888;">Todas las marcas</div>
                </div>
                <div class="card card-clickable" onclick="openModal('tarea')">
                  <div style="font-size: 32px; margin-bottom: 8px;">‚ûï</div>
                  <div style="font-size: 14px; font-weight: 500;">Nueva Tarea</div>
                  <div style="font-size: 12px; color: #888;">Agregar tarea r√°pida</div>
                </div>
              </div>
            </div>

            <div style="margin-top: 24px;">
              <div class="section-title" style="margin-bottom: 16px;">Tareas de hoy</div>
              <div id="dashboard-tasks-today"></div>
            </div>

            <div style="margin-top: 24px;">
              <div class="section-title" style="margin-bottom: 16px;">Actividad reciente</div>
              <div id="dashboard-activity"></div>
            </div>

          </div>

          <!-- TAREAS -->
          <div id="tareas" class="view">
            <div class="section-header">
              <h2 class="section-title">Mis tareas</h2>
              <button class="btn-add" onclick="openModal('tarea')">+ Nueva tarea</button>
            </div>
            <div id="tareas-list"></div>
          </div>

          <!-- EMPRESAS -->
          <div id="empresas" class="view">
            <div class="section-header">
              <h2 class="section-title">Mis empresas</h2>
              <button class="btn-add" onclick="openModal('empresa')">+ Nueva empresa</button>
            </div>
            <div class="grid grid-2" id="empresas-list"></div>
          </div>

          <!-- DOCUMENTOS -->
          <div id="documentos" class="view">
            <div class="section-header">
              <h2 class="section-title">Documentos</h2>
              <button class="btn-add" onclick="openModal('documento')">+ Nuevo documento</button>
            </div>
            <div id="documentos-list"></div>
          </div>

          <!-- DETALLE EMPRESA -->
          <div id="empresa-detalle" class="view">
            <button class="btn-back" onclick="goBack()">‚Üê Volver a empresas</button>
            <div id="empresa-detalle-content"></div>
          </div>

          <!-- MARCAS -->
          <div id="marcas" class="view">
            <div class="section-header">
              <h2 class="section-title">Todas las marcas</h2>
              <button class="btn-add" onclick="openModal('marca')">+ Nueva marca</button>
            </div>
            <div class="grid grid-2" id="marcas-list"></div>
          </div>

          <!-- DETALLE MARCA -->
          <div id="marca-detalle" class="view">
            <button class="btn-back" onclick="goBack()">‚Üê Volver a marcas</button>
            <div id="marca-detalle-content"></div>
          </div>

          <!-- SUSCRIPCIONES -->
          <div id="suscripciones" class="view">
            <div class="section-header">
              <h2 class="section-title">Todas las suscripciones</h2>
              <button class="btn-add" onclick="openModal('suscripcion')">+ Nueva suscripci√≥n</button>
            </div>
            <div id="suscripciones-list"></div>
          </div>

          <!-- CREDENCIALES -->
          <div id="credenciales" class="view">
            <div class="section-header">
              <h2 class="section-title">Todas las credenciales</h2>
              <button class="btn-add" onclick="openModal('credencial')">+ Nueva credencial</button>
            </div>
            <div id="credenciales-list"></div>
          </div>

          <!-- MEMORIA CONTABLE -->
          <div id="memoria" class="view">
            <div class="section-header">
              <h2 class="section-title">Memoria Contable</h2>
              <button class="btn-add" onclick="openModal('memoria')">+ Nueva entrada</button>
            </div>
            <div id="memoria-list"></div>
          </div>

        </main>

        ${getModalsHTML()}
      `;
    }

    function getModalsHTML() {
      return `
        <!-- Modales -->
        <div id="modal-empresa" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Nueva empresa</h3>
              <button class="modal-close" onclick="closeModal('empresa')">√ó</button>
            </div>
            <form id="form-empresa" onsubmit="submitEmpresa(event)">
              
              <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; margin-bottom: 16px; letter-spacing: 1px;">Informaci√≥n b√°sica</div>
              
              <div class="form-group">
                <label class="form-label">Nombre comercial *</label>
                <input type="text" name="name" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Nombre legal / Raz√≥n social</label>
                <input type="text" name="legalName" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">CIF/NIF</label>
                <input type="text" name="cif" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Direcci√≥n fiscal</label>
                <input type="text" name="fiscalAddress" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Tel√©fono principal</label>
                <input type="tel" name="phone" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Email principal</label>
                <input type="email" name="email" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Etiquetas (separadas por comas)</label>
                <input type="text" name="tags" class="form-input" placeholder="Activa, Principal, Fiscal 2024">
                <div style="font-size: 11px; color: #666; margin-top: 4px;">Escribe etiquetas separadas por comas. Ej: Activa, Principal, Holding</div>
              </div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; letter-spacing: 1px;">Cuentas bancarias</div>
                <button type="button" onclick="addBankAccount()" style="padding: 4px 10px; background: #1A1A1A; border: none; border-radius: 6px; color: #fff; font-size: 12px; cursor: pointer;">+ Agregar</button>
              </div>
              <div id="bank-accounts-container"></div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; letter-spacing: 1px;">Correos corporativos</div>
                <button type="button" onclick="addEmail()" style="padding: 4px 10px; background: #1A1A1A; border: none; border-radius: 6px; color: #fff; font-size: 12px; cursor: pointer;">+ Agregar</button>
              </div>
              <div id="emails-container"></div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; letter-spacing: 1px;">Redes sociales</div>
                <button type="button" onclick="addSocialMedia()" style="padding: 4px 10px; background: #1A1A1A; border: none; border-radius: 6px; color: #fff; font-size: 12px; cursor: pointer;">+ Agregar</button>
              </div>
              <div id="social-media-container"></div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div class="form-group">
                <label class="form-label">Notas</label>
                <textarea name="notes" class="form-textarea" placeholder="Cualquier informaci√≥n adicional relevante..."></textarea>
              </div>

              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('empresa')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar empresa</button>
              </div>
            </form>
          </div>
        </div>

        <div id="modal-marca" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Nueva marca</h3>
              <button class="modal-close" onclick="closeModal('marca')">√ó</button>
            </div>
            <form id="form-marca" onsubmit="submitMarca(event)">
              
              <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; margin-bottom: 16px; letter-spacing: 1px;">Informaci√≥n b√°sica</div>
              
              <div class="form-group">
                <label class="form-label">Nombre *</label>
                <input type="text" name="name" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Tipo</label>
                <input type="text" name="type" class="form-input" placeholder="App, Servicio, Producto, etc">
              </div>
              <div class="form-group">
                <label class="form-label">Facturada por *</label>
                <select name="companyId" class="form-select" required>
                  <option value="">Seleccionar empresa...</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Etiquetas (separadas por comas)</label>
                <input type="text" name="tags" class="form-input" placeholder="Activa, SaaS, Prioritario, Q1 2026">
                <div style="font-size: 11px; color: #666; margin-top: 4px;">Escribe etiquetas separadas por comas. Ej: Activa, Beta, Revenue</div>
              </div>
              <div class="form-group">
                <label class="form-label">Servicios</label>
                <input type="text" name="services" class="form-input" placeholder="Dise√±o ¬∑ Moda ¬∑ Branding">
              </div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; margin-bottom: 16px; letter-spacing: 1px;">Infraestructura digital</div>

              <div class="form-group">
                <label class="form-label">Dominio</label>
                <input type="text" name="domain" class="form-input" placeholder="ejemplo.com">
              </div>
              <div class="form-group">
                <label class="form-label">Proveedor dominio</label>
                <select name="domainProvider" class="form-select">
                  <option value="">Seleccionar...</option>
                  <option value="GoDaddy">GoDaddy</option>
                  <option value="Google Domains">Google Domains</option>
                  <option value="Porkbun">Porkbun</option>
                  <option value="Namecheap">Namecheap</option>
                  <option value="Cloudflare">Cloudflare</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Renovaci√≥n dominio</label>
                <input type="date" name="domainRenewal" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Hosting</label>
                <input type="text" name="hosting" class="form-input" placeholder="Vercel, Netlify, etc">
              </div>
              <div class="form-group">
                <label class="form-label">Backend/Database</label>
                <input type="text" name="backend" class="form-input" placeholder="Supabase, Firebase, etc">
              </div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; letter-spacing: 1px;">Correos de la marca</div>
                <button type="button" onclick="addBrandEmail()" style="padding: 4px 10px; background: #1A1A1A; border: none; border-radius: 6px; color: #fff; font-size: 12px; cursor: pointer;">+ Agregar</button>
              </div>
              <div id="brand-emails-container"></div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; letter-spacing: 1px;">Redes sociales</div>
                <button type="button" onclick="addBrandSocialMedia()" style="padding: 4px 10px; background: #1A1A1A; border: none; border-radius: 6px; color: #fff; font-size: 12px; cursor: pointer;">+ Agregar</button>
              </div>
              <div id="brand-social-media-container"></div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div class="form-group">
                <label class="form-label">Notas</label>
                <textarea name="notes" class="form-textarea" placeholder="Informaci√≥n adicional sobre esta marca..."></textarea>
              </div>

              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('marca')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar marca</button>
              </div>
            </form>
          </div>
        </div>

        <div id="modal-suscripcion" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Nueva suscripci√≥n</h3>
              <button class="modal-close" onclick="closeModal('suscripcion')">√ó</button>
            </div>
            <form id="form-suscripcion" onsubmit="submitSuscripcion(event)">
              <div class="form-group">
                <label class="form-label">Nombre *</label>
                <input type="text" name="name" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Coste mensual</label>
                <input type="text" name="cost" class="form-input" placeholder="29‚Ç¨/mes">
              </div>
              <div class="form-group">
                <label class="form-label">Plan (si es free)</label>
                <input type="text" name="plan" class="form-input" placeholder="Free, Pro, etc">
              </div>
              <div class="form-group">
                <label class="form-label">URL *</label>
                <input type="url" name="url" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Asociada a</label>
                <select name="association" class="form-select" id="suscripcion-association">
                  <option value="">Ninguna</option>
                  <optgroup label="Empresas"></optgroup>
                  <optgroup label="Marcas"></optgroup>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">D√≠a de renovaci√≥n</label>
                <input type="number" name="renewalDay" class="form-input" min="1" max="31" placeholder="18">
              </div>
              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('suscripcion')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar</button>
              </div>
            </form>
          </div>
        </div>

        <div id="modal-credencial" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Nueva credencial</h3>
              <button class="modal-close" onclick="closeModal('credencial')">√ó</button>
            </div>
            <form id="form-credencial" onsubmit="submitCredencial(event)">
              <div class="form-group">
                <label class="form-label">Servicio *</label>
                <input type="text" name="service" class="form-input" required placeholder="Instagram, Stripe, etc">
              </div>
              <div class="form-group">
                <label class="form-label">Usuario</label>
                <input type="text" name="username" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Password *</label>
                <input type="text" name="password" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Categor√≠a</label>
                <select name="category" class="form-select">
                  <option value="Social Media">Social Media</option>
                  <option value="Email">Email</option>
                  <option value="Pagos">Pagos</option>
                  <option value="Tech">Tech</option>
                  <option value="Dominios">Dominios</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Asociada a</label>
                <select name="association" class="form-select" id="credencial-association">
                  <option value="">Ninguna</option>
                  <optgroup label="Empresas"></optgroup>
                  <optgroup label="Marcas"></optgroup>
                </select>
              </div>
              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('credencial')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar</button>
              </div>
            </form>
          </div>
        </div>

        <div id="modal-tarea" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Nueva tarea</h3>
              <button class="modal-close" onclick="closeModal('tarea')">√ó</button>
            </div>
            <form id="form-tarea" onsubmit="submitTarea(event)">
              <div class="form-group">
                <label class="form-label">Descripci√≥n *</label>
                <input type="text" name="description" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Fecha</label>
                <input type="date" name="date" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Asociada a</label>
                <select name="association" class="form-select" id="tarea-association">
                  <option value="">Ninguna</option>
                  <optgroup label="Empresas"></optgroup>
                  <optgroup label="Marcas"></optgroup>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Notas</label>
                <textarea name="notes" class="form-textarea"></textarea>
              </div>
              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('tarea')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar</button>
              </div>
            </form>
          </div>
        </div>

        <div id="modal-memoria" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Nueva nota - Memoria Contable</h3>
              <button class="modal-close" onclick="closeModal('memoria')">√ó</button>
            </div>
            <form id="form-memoria" onsubmit="submitMemoria(event)">
              <input type="hidden" name="companyId" id="memoria-company-id">
              <div class="form-group">
                <label class="form-label">Tipo *</label>
                <select name="type" class="form-select" required>
                  <option value="Nota">Nota</option>
                  <option value="Cambio Contable">Cambio Contable</option>
                  <option value="Decisi√≥n">Decisi√≥n</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">T√≠tulo *</label>
                <input type="text" name="title" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Contenido *</label>
                <textarea name="content" class="form-textarea" required></textarea>
              </div>
              <div class="form-group">
                <label class="form-label">Fecha</label>
                <input type="date" name="date" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Referencia</label>
                <input type="text" name="ref" class="form-input" placeholder="Ej: Aportaci√≥n capital, Ep√≠grafes...">
              </div>
              <div class="form-group">
                <label class="form-label">Tags (separados por comas)</label>
                <input type="text" name="tags" class="form-input" placeholder="importante, revisar contabilidad">
              </div>
              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('memoria')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar</button>
              </div>
            </form>
          </div>
        </div>

        <div id="modal-nota" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Nueva nota</h3>
              <button class="modal-close" onclick="closeModal('nota')">√ó</button>
            </div>
            <form id="form-nota" onsubmit="submitNota(event)">
              <div class="form-group">
                <label class="form-label">T√≠tulo *</label>
                <input type="text" name="title" class="form-input" required placeholder="T√≠tulo de la nota">
              </div>
              <div class="form-group">
                <label class="form-label">Contenido *</label>
                <textarea name="content" class="form-textarea" rows="8" required placeholder="Escribe aqu√≠ tu nota..."></textarea>
              </div>
              <div class="form-group">
                <label class="form-label">Categor√≠a</label>
                <select name="category" class="form-select">
                  <option value="General">General</option>
                  <option value="Ideas">Ideas</option>
                  <option value="Reuni√≥n">Reuni√≥n</option>
                  <option value="Importante">Importante</option>
                  <option value="Pendiente">Pendiente</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Asociada a</label>
                <select name="association" class="form-select">
                  <option value="">Ninguna</option>
                  <optgroup label="Empresas"></optgroup>
                  <optgroup label="Marcas"></optgroup>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Tags (separados por comas)</label>
                <input type="text" name="tags" class="form-input" placeholder="urgente, revisar, idea">
              </div>
              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('nota')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar</button>
              </div>
            </form>
          </div>
        </div>

        <div id="modal-documento" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Nuevo documento</h3>
              <button class="modal-close" onclick="closeModal('documento')">√ó</button>
            </div>
            <form id="form-documento" onsubmit="submitDocumento(event)">
              <div class="form-group">
                <label class="form-label">Nombre *</label>
                <input type="text" name="name" class="form-input" required placeholder="Estatutos, Contrato...">
              </div>
              <div class="form-group">
                <label class="form-label">Tipo</label>
                <select name="type" class="form-select">
                  <option value="PDF">PDF</option>
                  <option value="Word">Word</option>
                  <option value="Excel">Excel</option>
                  <option value="Imagen">Imagen</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">URL / Link *</label>
                <input type="url" name="url" class="form-input" required placeholder="https://drive.google.com/...">
                <div style="font-size: 11px; color: #666; margin-top: 4px;">Link de Drive, Dropbox, Notion, etc</div>
              </div>
              <div class="form-group">
                <label class="form-label">Plataforma</label>
                <select name="platform" class="form-select">
                  <option value="Google Drive">Google Drive</option>
                  <option value="Dropbox">Dropbox</option>
                  <option value="Notion">Notion</option>
                  <option value="OneDrive">OneDrive</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Asociado a</label>
                <select name="association" class="form-select" id="documento-association">
                  <option value="">Ninguno</option>
                  <optgroup label="Empresas"></optgroup>
                  <optgroup label="Marcas"></optgroup>
                </select>
              </div>
              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('documento')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar</button>
              </div>
            </form>
          </div>
        </div>

        <div id="modal-config" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">‚öôÔ∏è Mi perfil y configuraci√≥n</h3>
              <button class="modal-close" onclick="closeModal('config')">√ó</button>
            </div>
            <form id="form-config" onsubmit="submitConfig(event)">
              
              <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; margin-bottom: 16px; letter-spacing: 1px;">Personalizaci√≥n del centro</div>
              
              <div class="form-group">
                <label class="form-label">Nombre del centro *</label>
                <input type="text" name="centerName" id="config-center-name" class="form-input" required placeholder="FGD VII ‚Äî Control Center">
              </div>
              <div class="form-group">
                <label class="form-label">Subt√≠tulo</label>
                <input type="text" name="centerSubtitle" id="config-center-subtitle" class="form-input" placeholder="Tu HQ completo">
              </div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; margin-bottom: 16px; letter-spacing: 1px;">Datos personales</div>
              
              <div class="form-group">
                <label class="form-label">Tu nombre *</label>
                <input type="text" name="userName" id="config-user-name" class="form-input" required placeholder="Fiorella Giselle Difortuna">
              </div>
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" name="userEmail" id="config-user-email" class="form-input" placeholder="fiorella@ricovidarte.com">
              </div>
              <div class="form-group">
                <label class="form-label">Tel√©fono</label>
                <input type="tel" name="userPhone" id="config-user-phone" class="form-input" placeholder="+34 600 123 456">
              </div>
              <div class="form-group">
                <label class="form-label">Ubicaci√≥n</label>
                <input type="text" name="userLocation" id="config-user-location" class="form-input" placeholder="Barcelona, Espa√±a">
              </div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div style="background: #1A1A1A; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                <div style="font-size: 13px; color: #888; line-height: 1.6;">
                  üí° <strong>Tip:</strong> Esta configuraci√≥n se guarda en tu navegador. Para acceder desde otros dispositivos, necesitar√°s integrar con base de datos (ver documentaci√≥n).
                </div>
              </div>

              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('config')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar configuraci√≥n</button>
              </div>
            </form>
          </div>
        </div>
      `;
    }

    // ============================================
    // FUNCI√ìN DE INICIALIZACI√ìN
    // ============================================
    function initializeApp() {
      // Configurar navegaci√≥n
      const navButtons = document.querySelectorAll('.nav-btn');
      navButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const view = btn.dataset.view;
          if (view) {
            showView(view);
          }
        });
      });

      // Configurar b√∫squeda global
      const searchInput = document.getElementById('global-search');
      if (searchInput) {
        searchInput.addEventListener('input', function () {
          globalSearch(this.value);
        });

        // Ocultar resultados al hacer clic fuera
        document.addEventListener('click', function (e) {
          if (!searchInput.contains(e.target)) {
            const searchResults = document.getElementById('search-results');
            if (searchResults) {
              searchResults.style.display = 'none';
            }
          }
        });
      }

      // Cargar datos guardados
      loadData();
      loadConfig();

      // Renderizar contenido inicial
      renderDashboard();
      renderTareas();
      renderEmpresas();
      renderMarcas();
      renderSuscripciones();
      renderCredenciales();
      renderDocumentos();
      renderNotas();
      renderMemoria();

      // Configurar fecha por defecto en formularios
      const today = new Date().toISOString().split('T')[0];
      const dateInputs = document.querySelectorAll('input[type="date"]');
      dateInputs.forEach(input => {
        if (!input.value) {
          input.value = today;
        }
      });

      // Configurar formularios din√°micos
      setupDynamicForms();

      // Configurar eventos para cerrar modales con Escape
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          const openModal = document.querySelector('.modal[style*="flex"]');
          if (openModal) {
            openModal.style.display = 'none';
          }
        }
      });

      console.log('‚úÖ Control Center inicializado correctamente');
    }

    function setupDynamicForms() {
      // Esta funci√≥n configurar√° los formularios din√°micos cuando sea necesario
      // Por ahora es un placeholder para futuras funcionalidades
    }

    // ============================================
    // INICIALIZACI√ìN AL CARGAR EL DOM
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
    });

    // Funciones renderizado (placeholders - las implementar√≠as seg√∫n tus necesidades)
    function renderDashboard() {
      const tasksToday = tasks.filter(task => {
        if (!task.date) return false;
        const taskDate = new Date(task.date);
        const today = new Date();
        return taskDate.toDateString() === today.toDateString();
      });

      const tasksCompleted = tasksToday.filter(task => task.completed);
      const tasksPending = tasksToday.filter(task => !task.completed);

      document.getElementById('tasks-today').textContent = tasksToday.length;
      document.getElementById('tasks-completed').textContent = tasksCompleted.length;
      document.getElementById('tasks-pending').textContent = tasksPending.length;

      // Renderizar tareas de hoy
      const dashboardTasksContainer = document.getElementById('dashboard-tasks-today');
      if (dashboardTasksContainer) {
        if (tasksToday.length === 0) {
          dashboardTasksContainer.innerHTML = '<div class="card"><p style="color: #888; text-align: center;">No hay tareas para hoy</p></div>';
        } else {
          dashboardTasksContainer.innerHTML = tasksToday.map(task => `
            <div class="card" style="margin-bottom: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="${task.completed ? 'text-decoration: line-through; color: #888;' : ''}">${task.description}</span>
                <button onclick="toggleTask('${task.id}')" style="padding: 4px 8px; background: ${task.completed ? '#4ADE80' : '#1A1A1A'}; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 12px;">
                  ${task.completed ? '‚úì' : '‚ñ°'}
                </button>
              </div>
            </div>
          `).join('');
        }
      }
    }

    function renderTareas() {
      const container = document.getElementById('tareas-list');
      if (!container) return;

      if (tasks.length === 0) {
        container.innerHTML = '<div class="card"><p style="color: #888; text-align: center;">No hay tareas registradas</p></div>';
        return;
      }

      container.innerHTML = tasks.map(task => {
        // Buscar la entidad asociada
        let entityCard = '';
        if (task.association) {
          const entity = [...companies, ...brands].find(e => 
            e.name === task.association || 
            e.id === task.association ||
            (e.legalName && e.legalName === task.association)
          );
          
          if (entity) {
            const entityColor = getColorFromId(entity.id);
            const entityInitial = entity.name.charAt(0).toUpperCase();
            const entityType = companies.includes(entity) ? 'Empresa' : 'Marca';
            
            entityCard = `
              <div style="display: inline-flex; align-items: center; gap: 8px; margin-top: 8px; padding: 8px 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="width: 32px; height: 32px; border-radius: 6px; background: ${entityColor}; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; flex-shrink: 0;">
                  ${entityInitial}
                </div>
                <div style="display: flex; flex-direction: column; min-width: 0;">
                  <div style="font-size: 13px; font-weight: 600; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    ${entity.name}
                  </div>
                  <div style="font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px;">
                    ${entityType}
                  </div>
                </div>
              </div>
            `;
          } else {
            // Si no se encuentra la entidad, mostrar solo el texto
            entityCard = `<div style="margin-top: 8px; font-size: 12px; color: #888;">Asociada a: ${task.association}</div>`;
          }
        }

        return `
          <div class="card" style="margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
              <h3 style="font-size: 16px; margin: 0; ${task.completed ? 'text-decoration: line-through; color: #888;' : ''}">${task.description}</h3>
              <div style="display: flex; gap: 8px;">
                <button onclick="toggleTask('${task.id}')" style="padding: 6px 12px; background: ${task.completed ? '#4ADE80' : '#1A1A1A'}; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">
                  ${task.completed ? 'Completada' : 'Pendiente'}
                </button>
                <button onclick="deleteTask('${task.id}')" style="padding: 6px 12px; background: #F87171; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">
                  Eliminar
                </button>
              </div>
            </div>
            <div style="font-size: 13px; color: #888;">
              Fecha: ${new Date(task.date).toLocaleDateString('es-ES')}
            </div>
            ${entityCard}
            ${task.notes ? `<div style="margin-top: 8px; font-size: 13px; color: #C8C8C8; padding-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.05);">${task.notes}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    function renderEmpresas() {
      const container = document.getElementById('empresas-list');
      if (!container) return;

      if (companies.length === 0) {
        container.innerHTML = '<div class="card"><p style="color: #888; text-align: center;">No hay empresas registradas</p></div>';
        return;
      }

      container.innerHTML = companies.map(company => `
        <div class="card card-clickable" onclick="showCompanyDetail('${company.id}')">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
            <div class="company-logo" style="background: ${getColorFromId(company.id)};">
              ${company.name.charAt(0).toUpperCase()}
            </div>
            <div style="flex: 1;">
              <h3 style="margin: 0 0 4px 0; font-size: 16px; font-weight: 600;">${company.name}</h3>
              <p style="margin: 0; font-size: 12px; color: #888;">${company.legalName || 'Sin raz√≥n social'}</p>
            </div>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 12px; color: #666;">${company.cif || 'Sin CIF'}</span>
            <div style="display: flex; gap: 8px;">
              <button onclick="event.stopPropagation(); editEmpresa('${company.id}')" style="padding: 4px 8px; background: #1A1A1A; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 11px;">Editar</button>
              <button onclick="event.stopPropagation(); deleteEmpresa('${company.id}')" style="padding: 4px 8px; background: #F87171; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 11px;">Eliminar</button>
            </div>
          </div>
          ${company.tags && company.tags.length > 0 ? `
            <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 4px;">
              ${company.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    function renderMarcas() {
      const container = document.getElementById('marcas-list');
      if (!container) return;

      if (brands.length === 0) {
        container.innerHTML = '<div class="card"><p style="color: #888; text-align: center;">No hay marcas registradas</p></div>';
        return;
      }

      container.innerHTML = brands.map(brand => {
        const company = companies.find(c => c.id === brand.companyId);
        return `
          <div class="card card-clickable" onclick="showBrandDetail('${brand.id}')">
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
              <div class="brand-logo" style="background: ${getColorFromId(brand.id)};">
                ${brand.name.charAt(0).toUpperCase()}
              </div>
              <div style="flex: 1;">
                <h3 style="margin: 0 0 4px 0; font-size: 16px; font-weight: 600;">${brand.name}</h3>
                <p style="margin: 0; font-size: 12px; color: #888;">${brand.type || 'Sin tipo definido'}</p>
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-size: 12px; color: #666;">Facturada por: ${company ? company.name : 'No asignada'}</span>
              <div style="display: flex; gap: 8px;">
                <button onclick="event.stopPropagation(); editMarca('${brand.id}')" style="padding: 4px 8px; background: #1A1A1A; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 11px;">Editar</button>
                <button onclick="event.stopPropagation(); deleteMarca('${brand.id}')" style="padding: 4px 8px; background: #F87171; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 11px;">Eliminar</button>
              </div>
            </div>
            ${brand.domain ? `<div style="font-size: 12px; color: #4ADE80; margin-bottom: 8px;">üåê ${brand.domain}</div>` : ''}
            ${brand.tags && brand.tags.length > 0 ? `
              <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                ${brand.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function renderSuscripciones() {
      const container = document.getElementById('suscripciones-list');
      if (!container) return;

      if (subscriptions.length === 0) {
        container.innerHTML = '<div class="card"><p style="color: #888; text-align: center;">No hay suscripciones registradas</p></div>';
        return;
      }

      container.innerHTML = subscriptions.map(sub => `
        <div class="card" style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <div style="flex: 1;">
              <h3 style="margin: 0 0 4px 0; font-size: 16px;">${sub.name}</h3>
              <div style="font-size: 13px; color: #888;">
                ${sub.cost || sub.plan || 'Coste no especificado'}
                ${sub.renewalDay ? ` ‚Ä¢ Renueva d√≠a ${sub.renewalDay}` : ''}
              </div>
              ${sub.association ? `<div style="font-size: 12px; color: #666; margin-top: 4px;">Asociada a: ${sub.association}</div>` : ''}
            </div>
            <div style="display: flex; gap: 8px;">
              <a href="${sub.url}" target="_blank" style="padding: 6px 12px; background: #4ADE80; border: none; border-radius: 6px; color: white; text-decoration: none; font-size: 12px;">
                Abrir
              </a>
              <button onclick="deleteSubscription('${sub.id}')" style="padding: 6px 12px; background: #F87171; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">
                Eliminar
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderCredenciales() {
      const container = document.getElementById('credenciales-list');
      if (!container) return;

      if (credentials.length === 0) {
        container.innerHTML = '<div class="card"><p style="color: #888; text-align: center;">No hay credenciales registradas</p></div>';
        return;
      }

      container.innerHTML = credentials.map(cred => `
        <div class="card" style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <div style="flex: 1;">
              <h3 style="margin: 0 0 4px 0; font-size: 16px;">${cred.service}</h3>
              <div style="font-size: 13px; color: #888;">
                ${cred.username || cred.email || 'Usuario no especificado'}
                ${cred.category ? ` ‚Ä¢ ${cred.category}` : ''}
              </div>
              ${cred.association ? `<div style="font-size: 12px; color: #666; margin-top: 4px;">Asociada a: ${cred.association}</div>` : ''}
            </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="copyToClipboard('${cred.password}')" style="padding: 6px 12px; background: #4ADE80; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">
                Copiar
              </button>
              <button onclick="deleteCredential('${cred.id}')" style="padding: 6px 12px; background: #F87171; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">
                Eliminar
              </button>
            </div>
          </div>
          <div style="font-size: 12px; color: #666; font-family: monospace; background: #1A1A1A; padding: 8px; border-radius: 4px; word-break: break-all;">
            ${cred.password}
          </div>
        </div>
      `).join('');
    }

    function renderDocumentos() {
      const container = document.getElementById('documentos-list');
      if (!container) return;

      if (documents.length === 0) {
        container.innerHTML = '<div class="card"><p style="color: #888; text-align: center;">No hay documentos registrados</p></div>';
        return;
      }

      container.innerHTML = documents.map(doc => `
        <div class="card" style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <div style="flex: 1;">
              <h3 style="margin: 0 0 4px 0; font-size: 16px;">${doc.name}</h3>
              <div style="font-size: 13px; color: #888;">
                ${doc.type || 'Archivo'} ‚Ä¢ ${doc.platform || 'Plataforma no especificada'}
              </div>
              ${doc.association ? `<div style="font-size: 12px; color: #666; margin-top: 4px;">Asociado a: ${doc.association}</div>` : ''}
            </div>
            <div style="display: flex; gap: 8px;">
              <a href="${doc.url}" target="_blank" style="padding: 6px 12px; background: #4ADE80; border: none; border-radius: 6px; color: white; text-decoration: none; font-size: 12px;">
                Abrir
              </a>
              <button onclick="deleteDocument('${doc.id}')" style="padding: 6px 12px; background: #F87171; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">
                Eliminar
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // SUSCRIPCIONES
    async function submitSuscripcion(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);

      const subscriptionData = {
        id: form.dataset.editId || 'sub_' + Date.now(),
        name: formData.get('name'),
        cost: formData.get('cost'),
        plan: formData.get('plan'),
        url: formData.get('url'),
        association: formData.get('association'),
        renewalDay: formData.get('renewalDay'),
        createdAt: new Date().toISOString()
      };

      try {
        if (form.dataset.editId) {
          const index = subscriptions.findIndex(s => s.id === form.dataset.editId);
          if (index !== -1) {
            subscriptions[index] = { ...subscriptions[index], ...subscriptionData };

            if (supabase && SUPABASE_CONFIG.enabled) {
              await saveToSupabase(subscriptions[index], 'subscriptions', 'subscription');
            }
          }
        } else {
          subscriptions.push(subscriptionData);

          if (supabase && SUPABASE_CONFIG.enabled) {
            await saveToSupabase(subscriptionData, 'subscriptions', 'subscription');
          }
        }

        saveData();
        renderSuscripciones();
        closeModal('suscripcion');
        form.reset();
        delete form.dataset.editId;

        console.log('‚úÖ Suscripci√≥n guardada correctamente');
      } catch (error) {
        console.error('‚ùå Error guardando suscripci√≥n:', error);
        alert('Error guardando suscripci√≥n. Revisa la consola para m√°s detalles.');
      }
    }

    // CREDENCIALES
    async function submitCredencial(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);

      const credentialData = {
        id: form.dataset.editId || 'cred_' + Date.now(),
        service: formData.get('service'),
        username: formData.get('username'),
        email: formData.get('email'),
        password: formData.get('password'),
        category: formData.get('category'),
        association: formData.get('association'),
        createdAt: new Date().toISOString()
      };

      console.log('üìù Guardando credencial:', credentialData);

      try {
        if (form.dataset.editId) {
          const index = credentials.findIndex(c => c.id === form.dataset.editId);
          if (index !== -1) {
            credentials[index] = { ...credentials[index], ...credentialData };

            if (supabase && SUPABASE_CONFIG.enabled) {
              console.log('‚òÅÔ∏è Sincronizando credencial editada con Supabase...');
              await saveToSupabase(credentials[index], 'credentials', 'credential');
              console.log('‚úÖ Credencial editada sincronizada con Supabase');
            }
          }
        } else {
          credentials.push(credentialData);

          if (supabase && SUPABASE_CONFIG.enabled) {
            console.log('‚òÅÔ∏è Guardando nueva credencial en Supabase...');
            await saveToSupabase(credentialData, 'credentials', 'credential');
            console.log('‚úÖ Nueva credencial guardada en Supabase');
          }
        }

        // Guardar en localStorage
        saveData();
        console.log('üíæ Credencial guardada en localStorage');
        
        renderCredenciales();
        closeModal('credencial');
        form.reset();
        delete form.dataset.editId;

        console.log('‚úÖ Credencial guardada correctamente en todos los sistemas');
      } catch (error) {
        console.error('‚ùå Error guardando credencial:', error);
        alert('Error guardando credencial. Revisa la consola para m√°s detalles.');
      }
    }

    // DOCUMENTOS
    async function submitDocumento(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);

      const documentData = {
        id: form.dataset.editId || 'doc_' + Date.now(),
        name: formData.get('name'),
        type: formData.get('type'),
        url: formData.get('url'),
        platform: formData.get('platform'),
        association: formData.get('association'),
        createdAt: new Date().toISOString()
      };

      try {
        if (form.dataset.editId) {
          const index = documents.findIndex(d => d.id === form.dataset.editId);
          if (index !== -1) {
            documents[index] = { ...documents[index], ...documentData };

            if (supabase && SUPABASE_CONFIG.enabled) {
              await saveToSupabase(documents[index], 'documents', 'document');
            }
          }
        } else {
          documents.push(documentData);

          if (supabase && SUPABASE_CONFIG.enabled) {
            await saveToSupabase(documentData, 'documents', 'document');
          }
        }

        saveData();
        renderDocumentos();
        closeModal('documento');
        form.reset();
        delete form.dataset.editId;

        console.log('‚úÖ Documento guardado correctamente');
      } catch (error) {
        console.error('‚ùå Error guardando documento:', error);
        alert('Error guardando documento. Revisa la consola para m√°s detalles.');
      }
    }

    // NOTAS
    async function submitNota(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);

      const notaData = {
        id: form.dataset.editId || 'nota_' + Date.now(),
        title: formData.get('title'),
        content: formData.get('content'),
        category: formData.get('category'),
        association: formData.get('association'),
        tags: formData.get('tags') ? formData.get('tags').split(',').map(t => t.trim()) : [],
        createdAt: new Date().toISOString()
      };

      try {
        if (form.dataset.editId) {
          const index = notas.findIndex(n => n.id === form.dataset.editId);
          if (index !== -1) {
            notas[index] = { ...notas[index], ...notaData };
          }
        } else {
          notas.push(notaData);
        }

        saveData();
        renderNotas();
        closeModal('nota');
        form.reset();
        delete form.dataset.editId;

        console.log('‚úÖ Nota guardada correctamente');
      } catch (error) {
        console.error('‚ùå Error guardando nota:', error);
        alert('Error guardando nota. Revisa la consola para m√°s detalles.');
      }
    }

    function renderNotas() {
      const container = document.getElementById('notas-list');
      if (!container) return;

      if (notas.length === 0) {
        container.innerHTML = '<div class="card"><p style="color: #888; text-align: center;">No hay notas</p></div>';
        return;
      }

      container.innerHTML = notas.map(nota => `
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <div style="flex: 1;">
              <h3 style="margin: 0 0 4px 0; font-size: 16px; font-weight: 600;">${nota.title}</h3>
              <p style="margin: 0; font-size: 12px; color: #888;">${nota.category || 'General'}</p>
            </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="editNota('${nota.id}')" style="padding: 4px 8px; background: #1A1A1A; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 11px;">Editar</button>
              <button onclick="deleteNota('${nota.id}')" style="padding: 4px 8px; background: #F87171; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 11px;">Eliminar</button>
            </div>
          </div>
          <p style="margin: 0 0 12px 0; color: #ccc; font-size: 14px; white-space: pre-wrap;">${nota.content}</p>
          ${nota.tags && nota.tags.length > 0 ? `
            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
              ${nota.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
            </div>
          ` : ''}
          <p style="margin: 12px 0 0 0; font-size: 11px; color: #666;">${new Date(nota.createdAt).toLocaleDateString()}</p>
        </div>
      `).join('');
    }

    function editNota(id) {
      const nota = notas.find(n => n.id === id);
      if (!nota) return;

      const form = document.getElementById('form-nota');
      const modal = document.getElementById('modal-nota');
      const title = modal.querySelector('.modal-title');

      form.dataset.editId = id;
      openModal('nota');

      title.textContent = 'Editar nota';
      form.title.value = nota.title || '';
      form.content.value = nota.content || '';
      form.category.value = nota.category || 'General';
      form.association.value = nota.association || '';
      form.tags.value = nota.tags ? nota.tags.join(', ') : '';
    }

    async function deleteNota(id) {
      if (confirm('¬øEst√°s seguro de que deseas eliminar esta nota?')) {
        try {
          notas = notas.filter(n => n.id !== id);
          saveData();
          renderNotas();
          console.log('‚úÖ Nota eliminada correctamente');
        } catch (error) {
          console.error('‚ùå Error eliminando nota:', error);
          alert('Error eliminando nota. Revisa la consola.');
        }
      }
    }

    // MEMORIA CONTABLE
    async function submitMemoria(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);

      const memoriaData = {
        id: form.dataset.editId || 'memoria_' + Date.now(),
        title: formData.get('title'),
        content: formData.get('content'),
        date: formData.get('date'),
        ref: formData.get('ref'),
        tags: formData.get('tags') ? formData.get('tags').split(',').map(t => t.trim()) : [],
        createdAt: new Date().toISOString()
      };

      try {
        if (form.dataset.editId) {
          const index = memoriaContable.findIndex(m => m.id === form.dataset.editId);
          if (index !== -1) {
            memoriaContable[index] = { ...memoriaContable[index], ...memoriaData };
          }
        } else {
          memoriaContable.push(memoriaData);
        }

        saveData();
        renderMemoria();
        closeModal('memoria');
        form.reset();
        delete form.dataset.editId;

        console.log('‚úÖ Memoria guardada correctamente');
      } catch (error) {
        console.error('‚ùå Error guardando memoria:', error);
        alert('Error guardando memoria. Revisa la consola para m√°s detalles.');
      }
    }

    function renderMemoria() {
      const container = document.getElementById('memoria-list');
      if (!container) return;

      if (memoriaContable.length === 0) {
        container.innerHTML = '<div class="card"><p style="color: #888; text-align: center;">No hay entradas en la memoria contable</p></div>';
        return;
      }

      container.innerHTML = memoriaContable.map(memoria => `
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <div style="flex: 1;">
              <h3 style="margin: 0 0 4px 0; font-size: 16px; font-weight: 600;">${memoria.title}</h3>
              <p style="margin: 0; font-size: 12px; color: #888;">${memoria.ref || 'Sin referencia'} ¬∑ ${new Date(memoria.date).toLocaleDateString()}</p>
            </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="editMemoria('${memoria.id}')" style="padding: 4px 8px; background: #1A1A1A; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 11px;">Editar</button>
              <button onclick="deleteMemoria('${memoria.id}')" style="padding: 4px 8px; background: #F87171; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 11px;">Eliminar</button>
            </div>
          </div>
          <p style="margin: 0 0 12px 0; color: #ccc; font-size: 14px; white-space: pre-wrap;">${memoria.content}</p>
          ${memoria.tags && memoria.tags.length > 0 ? `
            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
              ${memoria.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    function editMemoria(id) {
      const memoria = memoriaContable.find(m => m.id === id);
      if (!memoria) return;

      const form = document.getElementById('form-memoria');
      const modal = document.getElementById('modal-memoria');
      const title = modal.querySelector('.modal-title');

      form.dataset.editId = id;
      openModal('memoria');

      title.textContent = 'Editar memoria';
      form.title.value = memoria.title || '';
      form.content.value = memoria.content || '';
      form.date.value = memoria.date || '';
      form.ref.value = memoria.ref || '';
      form.tags.value = memoria.tags ? memoria.tags.join(', ') : '';
    }

    async function deleteMemoria(id) {
      if (confirm('¬øEst√°s seguro de que deseas eliminar esta entrada?')) {
        try {
          memoriaContable = memoriaContable.filter(m => m.id !== id);
          saveData();
          renderMemoria();
          console.log('‚úÖ Memoria eliminada correctamente');
        } catch (error) {
          console.error('‚ùå Error eliminando memoria:', error);
          alert('Error eliminando memoria. Revisa la consola.');
        }
      }
    }

    // CONFIGURACI√ìN
    async function submitConfig(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);

      const configData = {
        centerName: formData.get('centerName'),
        centerSubtitle: formData.get('centerSubtitle'),
        userName: formData.get('userName'),
        userEmail: formData.get('userEmail'),
        userPhone: formData.get('userPhone'),
        userLocation: formData.get('userLocation')
      };

      try {
        // Guardar configuraci√≥n
        localStorage.setItem('config', JSON.stringify(configData));

        // Aplicar cambios inmediatamente
        if (configData.centerName) {
          const nameEl = document.getElementById('center-name');
          if (nameEl) nameEl.textContent = configData.centerName;
        }
        if (configData.centerSubtitle) {
          const subtitleEl = document.getElementById('center-subtitle');
          if (subtitleEl) subtitleEl.textContent = configData.centerSubtitle;
        }

        closeModal('config');
        form.reset();

        alert('‚úÖ Configuraci√≥n guardada correctamente');
        console.log('‚úÖ Configuraci√≥n guardada correctamente');
      } catch (error) {
        console.error('‚ùå Error guardando configuraci√≥n:', error);
        alert('Error guardando configuraci√≥n. Revisa la consola para m√°s detalles.');
      }
    }

    // FUNCIONES DE SUPABASE

    // Transformar datos del formato local al formato de Supabase
    function transformToSupabase(data, type) {
      const base = {
        id: data.id,
        created_at: data.createdAt || new Date().toISOString()
      };

      switch (type) {
        case 'company':
          return {
            ...base,
            name: data.name,
            legal_name: data.legalName || null,
            cif: data.cif || null,
            fiscal_address: data.fiscalAddress || null,
            phone: data.phone || null,
            email: data.email || null,
            tags: data.tags || [],
            bank_accounts: data.bankAccounts || [],
            emails: data.emails || [],
            social_media: data.socialMedia || [],
            notes: data.notes || null
          };

        case 'brand':
          return {
            ...base,
            name: data.name,
            type: data.type || null,
            company_id: data.companyId || null,
            tags: data.tags || [],
            services: data.services || null,
            domain: data.domain || null,
            domain_provider: data.domainProvider || null,
            domain_renewal: data.domainRenewal || null,
            hosting: data.hosting || null,
            backend: data.backend || null,
            emails: data.emails || [],
            social_media: data.socialMedia || [],
            notes: data.notes || null
          };

        case 'task':
          return {
            ...base,
            description: data.description,
            date: data.date || null,
            completed: data.completed || false,
            association: data.association || null,
            notes: data.notes || null
          };

        case 'subscription':
          return {
            ...base,
            name: data.name,
            cost: data.cost || null,
            plan: data.plan || null,
            url: data.url || null,
            association: data.association || null,
            renewal_day: data.renewalDay || null
          };

        case 'credential':
          return {
            ...base,
            service: data.service,
            username: data.username || null,
            email: data.email || null,
            password: data.password || null,
            category: data.category || null,
            association: data.association || null
          };

        default:
          return data;
      }
    }

    async function saveToSupabase(data, table, type) {
      if (!supabase) {
        console.log('Supabase no disponible, guardando solo en localStorage');
        return;
      }

      try {
        const transformedData = transformToSupabase(data, type);
        const { data: result, error } = await supabase
          .from(table)
          .upsert(transformedData)
          .select();

        if (error) {
          console.error('Error guardando en Supabase:', error);
          throw error;
        }

        console.log('‚úÖ Datos guardados en Supabase:', result);
        return result;
      } catch (error) {
        console.error('‚ùå Error en saveToSupabase:', error);
        throw error;
      }
    }

    async function deleteFromSupabase(id, table) {
      if (!supabase) {
        console.log('Supabase no disponible');
        return;
      }

      try {
        const { error } = await supabase
          .from(table)
          .delete()
          .eq('id', id);

        if (error) {
          console.error('Error eliminando de Supabase:', error);
          throw error;
        }

        console.log('‚úÖ Eliminado de Supabase');
      } catch (error) {
        console.error('‚ùå Error en deleteFromSupabase:', error);
        throw error;
      }
    }

    // ============================================
    // FUNCIONES PARA AGREGAR CAMPOS DIN√ÅMICOS
    // ============================================

    // Generar color aleatorio basado en un ID
    function getColorFromId(id) {
      const colors = [
        ['#4ADE80', '#22C55E'], // Verde
        ['#60A5FA', '#3B82F6'], // Azul
        ['#A78BFA', '#7C3AED'], // P√∫rpura
        ['#F472B6', '#EC4899'], // Rosa
        ['#FBBF24', '#F59E0B'], // Amarillo
        ['#FB923C', '#F97316'], // Naranja
        ['#34D399', '#10B981'], // Esmeralda
        ['#F87171', '#EF4444'], // Rojo
        ['#38BDF8', '#0EA5E9'], // Azul cielo
        ['#C084FC', '#A855F7'], // Violeta
        ['#FCD34D', '#FBBF24'], // √Åmbar
        ['#6EE7B7', '#34D399'], // Verde menta
      ];

      // Usar el ID para seleccionar un color de forma consistente
      let hash = 0;
      for (let i = 0; i < id.length; i++) {
        hash = id.charCodeAt(i) + ((hash << 5) - hash);
      }
      const index = Math.abs(hash) % colors.length;
      const [color1, color2] = colors[index];

      return `linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`;
    }

    // Funciones para agregar emails a marcas
    function addBrandEmail() {
      const container = document.getElementById('brand-emails-container');
      const emailDiv = document.createElement('div');
      emailDiv.className = 'dynamic-field';
      emailDiv.innerHTML = `
        <input type="email" name="brandEmail[]" class="form-input" placeholder="hola@marca.com" style="flex: 1;">
        <button type="button" onclick="this.parentElement.remove()" class="btn-remove">√ó</button>
      `;
      container.appendChild(emailDiv);
    }

    // Funciones para agregar redes sociales a marcas
    function addBrandSocialMedia() {
      const container = document.getElementById('brand-social-media-container');
      const socialDiv = document.createElement('div');
      socialDiv.className = 'dynamic-field';
      socialDiv.innerHTML = `
        <select name="brandSocialPlatform[]" class="form-select" style="flex: 0 0 120px;">
          <option value="Instagram">Instagram</option>
          <option value="Facebook">Facebook</option>
          <option value="Twitter">Twitter</option>
          <option value="LinkedIn">LinkedIn</option>
          <option value="TikTok">TikTok</option>
          <option value="YouTube">YouTube</option>
        </select>
        <input type="text" name="brandSocialUrl[]" class="form-input" placeholder="@usuario o URL" style="flex: 1;">
        <button type="button" onclick="this.parentElement.remove()" class="btn-remove">√ó</button>
      `;
      container.appendChild(socialDiv);
    }

    // Funciones para agregar cuentas bancarias a empresas
    function addBankAccount() {
      const container = document.getElementById('bank-accounts-container');
      const bankDiv = document.createElement('div');
      bankDiv.className = 'dynamic-field';
      bankDiv.innerHTML = `
        <input type="text" name="bankName[]" class="form-input" placeholder="Banco" style="flex: 0 0 120px;">
        <input type="text" name="iban[]" class="form-input" placeholder="IBAN" style="flex: 1;">
        <button type="button" onclick="this.parentElement.remove()" class="btn-remove">√ó</button>
      `;
      container.appendChild(bankDiv);
    }

    // Funciones para agregar emails a empresas
    function addEmail() {
      const container = document.getElementById('emails-container');
      const emailDiv = document.createElement('div');
      emailDiv.className = 'dynamic-field';
      emailDiv.innerHTML = `
        <input type="email" name="companyEmail[]" class="form-input" placeholder="contacto@empresa.com" style="flex: 1;">
        <button type="button" onclick="this.parentElement.remove()" class="btn-remove">√ó</button>
      `;
      container.appendChild(emailDiv);
    }

    // Funciones para agregar redes sociales a empresas
    function addSocialMedia() {
      const container = document.getElementById('social-media-container');
      const socialDiv = document.createElement('div');
      socialDiv.className = 'dynamic-field';
      socialDiv.innerHTML = `
        <select name="companySocialPlatform[]" class="form-select" style="flex: 0 0 120px;">
          <option value="Instagram">Instagram</option>
          <option value="Facebook">Facebook</option>
          <option value="Twitter">Twitter</option>
          <option value="LinkedIn">LinkedIn</option>
          <option value="TikTok">TikTok</option>
          <option value="YouTube">YouTube</option>
        </select>
        <input type="text" name="companySocialUrl[]" class="form-input" placeholder="@usuario o URL" style="flex: 1;">
        <button type="button" onclick="this.parentElement.remove()" class="btn-remove">√ó</button>
      `;
      container.appendChild(socialDiv);
    }

    // ============================================
    // FUNCIONES CRUD PRINCIPALES
    // ============================================

    // EMPRESAS
    async function submitEmpresa(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);

      // Recoger cuentas bancarias
      const bankNames = formData.getAll('bankName[]');
      const ibans = formData.getAll('iban[]');
      const bankAccounts = bankNames.map((name, index) => ({
        bank: name,
        iban: ibans[index]
      })).filter(acc => acc.bank || acc.iban);

      // Recoger emails corporativos
      const companyEmails = formData.getAll('companyEmail[]').filter(e => e);

      // Recoger redes sociales
      const socialPlatforms = formData.getAll('companySocialPlatform[]');
      const socialUrls = formData.getAll('companySocialUrl[]');
      const socialMedia = socialPlatforms.map((platform, index) => ({
        platform: platform,
        url: socialUrls[index]
      })).filter(social => social.url);

      const companyData = {
        id: form.dataset.editId || 'comp_' + Date.now(),
        name: formData.get('name'),
        legalName: formData.get('legalName'),
        cif: formData.get('cif'),
        fiscalAddress: formData.get('fiscalAddress'),
        phone: formData.get('phone'),
        email: formData.get('email'),
        tags: formData.get('tags') ? formData.get('tags').split(',').map(t => t.trim()) : [],
        bankAccounts: bankAccounts,
        emails: companyEmails,
        socialMedia: socialMedia,
        notes: formData.get('notes'),
        createdAt: new Date().toISOString()
      };

      try {
        if (form.dataset.editId) {
          const index = companies.findIndex(c => c.id === form.dataset.editId);
          if (index !== -1) {
            companies[index] = { ...companies[index], ...companyData };

            if (supabase && SUPABASE_CONFIG.enabled) {
              await saveToSupabase(companies[index], 'companies', 'company');
            }
          }
        } else {
          companies.push(companyData);

          if (supabase && SUPABASE_CONFIG.enabled) {
            await saveToSupabase(companyData, 'companies', 'company');
          }
        }

        saveData();
        renderEmpresas();
        closeModal('empresa');
        form.reset();
        delete form.dataset.editId;

        console.log('‚úÖ Empresa guardada correctamente');
      } catch (error) {
        console.error('‚ùå Error guardando empresa:', error);
        alert('Error guardando empresa. Revisa la consola para m√°s detalles.');
      }
    }

    function editEmpresa(id) {
      const company = companies.find(c => c.id === id);
      if (!company) {
        console.error('Empresa no encontrada:', id);
        return;
      }

      const form = document.getElementById('form-empresa');
      const modal = document.getElementById('modal-empresa');
      const title = modal.querySelector('.modal-title');

      if (!form || !modal) {
        console.error('Formulario o modal no encontrado');
        return;
      }

      // Mostrar el modal primero
      modal.style.display = 'flex';

      // Cambiar el t√≠tulo
      title.textContent = 'Editar empresa';

      // Llenar los campos del formulario
      form.querySelector('[name="name"]').value = company.name || '';
      form.querySelector('[name="legalName"]').value = company.legalName || '';
      form.querySelector('[name="cif"]').value = company.cif || '';
      form.querySelector('[name="fiscalAddress"]').value = company.fiscalAddress || '';
      form.querySelector('[name="phone"]').value = company.phone || '';
      form.querySelector('[name="email"]').value = company.email || '';
      form.querySelector('[name="tags"]').value = company.tags ? company.tags.join(', ') : '';

      const notesField = form.querySelector('[name="notes"]');
      if (notesField) {
        notesField.value = company.notes || '';
      }

      // Limpiar y cargar cuentas bancarias
      const bankContainer = document.getElementById('bank-accounts-container');
      bankContainer.innerHTML = '';
      if (company.bankAccounts && company.bankAccounts.length > 0) {
        company.bankAccounts.forEach(account => {
          const bankDiv = document.createElement('div');
          bankDiv.className = 'dynamic-field';
          bankDiv.innerHTML = `
            <input type="text" name="bankName[]" class="form-input" placeholder="Banco" style="flex: 0 0 120px;" value="${account.bank || ''}">
            <input type="text" name="iban[]" class="form-input" placeholder="IBAN" style="flex: 1;" value="${account.iban || ''}">
            <button type="button" onclick="this.parentElement.remove()" class="btn-remove">√ó</button>
          `;
          bankContainer.appendChild(bankDiv);
        });
      }

      // Limpiar y cargar emails
      const emailsContainer = document.getElementById('emails-container');
      emailsContainer.innerHTML = '';
      if (company.emails && company.emails.length > 0) {
        company.emails.forEach(email => {
          const emailDiv = document.createElement('div');
          emailDiv.className = 'dynamic-field';
          emailDiv.innerHTML = `
            <input type="email" name="companyEmail[]" class="form-input" placeholder="contacto@empresa.com" style="flex: 1;" value="${email}">
            <button type="button" onclick="this.parentElement.remove()" class="btn-remove">√ó</button>
          `;
          emailsContainer.appendChild(emailDiv);
        });
      }

      // Limpiar y cargar redes sociales
      const socialContainer = document.getElementById('social-media-container');
      socialContainer.innerHTML = '';
      if (company.socialMedia && company.socialMedia.length > 0) {
        company.socialMedia.forEach(social => {
          const socialDiv = document.createElement('div');
          socialDiv.className = 'dynamic-field';
          socialDiv.innerHTML = `
            <select name="companySocialPlatform[]" class="form-select" style="flex: 0 0 120px;">
              <option value="Instagram" ${social.platform === 'Instagram' ? 'selected' : ''}>Instagram</option>
              <option value="Facebook" ${social.platform === 'Facebook' ? 'selected' : ''}>Facebook</option>
              <option value="Twitter" ${social.platform === 'Twitter' ? 'selected' : ''}>Twitter</option>
              <option value="LinkedIn" ${social.platform === 'LinkedIn' ? 'selected' : ''}>LinkedIn</option>
              <option value="TikTok" ${social.platform === 'TikTok' ? 'selected' : ''}>TikTok</option>
              <option value="YouTube" ${social.platform === 'YouTube' ? 'selected' : ''}>YouTube</option>
            </select>
            <input type="text" name="companySocialUrl[]" class="form-input" placeholder="@usuario o URL" style="flex: 1;" value="${social.url || ''}">
            <button type="button" onclick="this.parentElement.remove()" class="btn-remove">√ó</button>
          `;
          socialContainer.appendChild(socialDiv);
        });
      }

      // Marcar que estamos editando
      form.dataset.editId = id;
      console.log('Editando empresa:', company.name, 'ID:', id);
    }

    // MARCAS
    async function submitMarca(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);

      // Recoger emails de la marca
      const brandEmails = formData.getAll('brandEmail[]').filter(e => e);

      // Recoger redes sociales de la marca
      const brandSocialPlatforms = formData.getAll('brandSocialPlatform[]');
      const brandSocialUrls = formData.getAll('brandSocialUrl[]');
      const brandSocialMedia = brandSocialPlatforms.map((platform, index) => ({
        platform: platform,
        url: brandSocialUrls[index]
      })).filter(social => social.url);

      const brandData = {
        id: form.dataset.editId || 'brand_' + Date.now(),
        name: formData.get('name'),
        type: formData.get('type'),
        companyId: formData.get('companyId'),
        tags: formData.get('tags') ? formData.get('tags').split(',').map(t => t.trim()) : [],
        services: formData.get('services'),
        domain: formData.get('domain'),
        domainProvider: formData.get('domainProvider'),
        domainRenewal: formData.get('domainRenewal'),
        hosting: formData.get('hosting'),
        backend: formData.get('backend'),
        emails: brandEmails,
        socialMedia: brandSocialMedia,
        notes: formData.get('notes'),
        createdAt: new Date().toISOString()
      };

      try {
        if (form.dataset.editId) {
          const index = brands.findIndex(b => b.id === form.dataset.editId);
          if (index !== -1) {
            brands[index] = { ...brands[index], ...brandData };

            if (supabase && SUPABASE_CONFIG.enabled) {
              await saveToSupabase(brands[index], 'brands', 'brand');
            }
          }
        } else {
          brands.push(brandData);

          if (supabase && SUPABASE_CONFIG.enabled) {
            await saveToSupabase(brandData, 'brands', 'brand');
          }
        }

        saveData();
        renderMarcas();
        closeModal('marca');
        form.reset();
        delete form.dataset.editId;

        console.log('‚úÖ Marca guardada correctamente');
      } catch (error) {
        console.error('‚ùå Error guardando marca:', error);
        alert('Error guardando marca. Revisa la consola para m√°s detalles.');
      }
    }

    function editMarca(id) {
      const brand = brands.find(b => b.id === id);
      if (!brand) return;

      const form = document.getElementById('form-marca');
      const modal = document.getElementById('modal-marca');
      const title = modal.querySelector('.modal-title');

      // Marcar como edici√≥n ANTES de abrir el modal
      form.dataset.editId = id;

      // Abrir modal (esto poblar√° los selects)
      openModal('marca');

      // Ahora llenar los valores
      title.textContent = 'Editar marca';

      form.name.value = brand.name || '';
      form.type.value = brand.type || '';
      form.tags.value = brand.tags ? brand.tags.join(', ') : '';
      form.services.value = brand.services || '';
      form.domain.value = brand.domain || '';
      form.domainProvider.value = brand.domainProvider || '';
      form.domainRenewal.value = brand.domainRenewal || '';
      form.hosting.value = brand.hosting || '';
      form.backend.value = brand.backend || '';
      form.notes.value = brand.notes || '';

      // Seleccionar la empresa correcta
      const companySelect = form.companyId;
      if (companySelect && brand.companyId) {
        companySelect.value = brand.companyId;
      }
    }

    // TAREAS
    async function submitTarea(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);

      const taskData = {
        id: form.dataset.editId || 'task_' + Date.now(),
        description: formData.get('description'),
        date: formData.get('date'),
        completed: false,
        association: formData.get('association'),
        notes: formData.get('notes'),
        createdAt: new Date().toISOString()
      };

      try {
        if (form.dataset.editId) {
          const index = tasks.findIndex(t => t.id === form.dataset.editId);
          if (index !== -1) {
            tasks[index] = { ...tasks[index], ...taskData, completed: tasks[index].completed };

            if (supabase && SUPABASE_CONFIG.enabled) {
              await saveToSupabase(tasks[index], 'tasks', 'task');
            }
          }
        } else {
          tasks.push(taskData);

          if (supabase && SUPABASE_CONFIG.enabled) {
            await saveToSupabase(taskData, 'tasks', 'task');
          }
        }

        saveData();
        renderTareas();
        renderDashboard();
        closeModal('tarea');
        form.reset();
        delete form.dataset.editId;

        console.log('‚úÖ Tarea guardada correctamente');
      } catch (error) {
        console.error('‚ùå Error guardando tarea:', error);
        alert('Error guardando tarea. Revisa la consola para m√°s detalles.');
      }
    }

    // ============================================
    // FUNCIONES DE INTERFAZ DE USUARIO
    // ============================================

    // Funci√≥n para cambiar entre vistas
    function showView(viewName) {
      // Ocultar todas las vistas
      const views = document.querySelectorAll('.view');
      views.forEach(view => {
        view.classList.remove('active');
        view.style.display = 'none';
      });

      // Mostrar la vista seleccionada
      const targetView = document.getElementById(viewName);
      if (targetView) {
        targetView.classList.add('active');
        targetView.style.display = 'block';
      }

      // Actualizar botones de navegaci√≥n
      const navBtns = document.querySelectorAll('.nav-btn');
      navBtns.forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.view === viewName) {
          btn.classList.add('active');
        }
      });
    }

    // Funciones para manejar modales
    function openModal(modalType) {
      const modal = document.getElementById('modal-' + modalType);
      if (modal) {
        modal.style.display = 'flex';

        // Limpiar formulario si existe Y NO es una edici√≥n
        const form = modal.querySelector('form');
        if (form && !form.dataset.editId) {
          form.reset();
          
          // Limpiar contenedores din√°micos de empresas
          if (modalType === 'empresa') {
            const bankContainer = document.getElementById('bank-accounts-container');
            const emailsContainer = document.getElementById('emails-container');
            const socialContainer = document.getElementById('social-media-container');
            if (bankContainer) bankContainer.innerHTML = '';
            if (emailsContainer) emailsContainer.innerHTML = '';
            if (socialContainer) socialContainer.innerHTML = '';
          }
        }

        // Actualizar t√≠tulo del modal solo si NO es una edici√≥n
        const title = modal.querySelector('.modal-title');
        if (title && !form?.dataset.editId) {
          const titles = {
            empresa: 'Nueva empresa',
            marca: 'Nueva marca',
            tarea: 'Nueva tarea',
            suscripcion: 'Nueva suscripci√≥n',
            credencial: 'Nueva credencial',
            documento: 'Nuevo documento',
            config: 'Configuraci√≥n',
            memoria: 'Nueva memoria contable',
            nota: 'Nueva nota'
          };
          title.textContent = titles[modalType] || 'Modal';
        }

        // Llenar selects con datos din√°micos
        if (modalType === 'marca') {
          // Llenar select de empresas
          const companySelect = modal.querySelector('select[name="companyId"]');
          if (companySelect) {
            companySelect.innerHTML = '<option value="">Seleccionar empresa...</option>';
            companies.forEach(company => {
              const option = document.createElement('option');
              option.value = company.id;
              option.textContent = company.name;
              companySelect.appendChild(option);
            });
          }
        }

        if (modalType === 'suscripcion' || modalType === 'credencial' || modalType === 'documento' || modalType === 'tarea' || modalType === 'nota') {
          // Llenar select de asociaci√≥n con empresas y marcas
          const associationSelect = modal.querySelector('select[name="association"]');
          if (associationSelect) {
            associationSelect.innerHTML = '<option value="">Ninguna</option>';

            // Agregar empresas
            if (companies.length > 0) {
              const companiesGroup = document.createElement('optgroup');
              companiesGroup.label = 'Empresas';
              companies.forEach(company => {
                const option = document.createElement('option');
                option.value = `company:${company.id}`;
                option.textContent = company.name;
                companiesGroup.appendChild(option);
              });
              associationSelect.appendChild(companiesGroup);
            }

            // Agregar marcas
            if (brands.length > 0) {
              const brandsGroup = document.createElement('optgroup');
              brandsGroup.label = 'Marcas';
              brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = `brand:${brand.id}`;
                option.textContent = brand.name;
                brandsGroup.appendChild(option);
              });
              associationSelect.appendChild(brandsGroup);
            }
          }
        }
      }
    }

    function closeModal(modalType) {
      const modal = document.getElementById('modal-' + modalType);
      if (modal) {
        modal.style.display = 'none';

        // Limpiar el formulario al cerrar
        const form = modal.querySelector('form');
        if (form) {
          form.reset();
          delete form.dataset.editId;
        }
      }
    }

    // Alias para showModal
    function showModal(modalType) {
      openModal(modalType);
    }

    // Cerrar modales al hacer clic fuera
    window.onclick = function (event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }

    // Funci√≥n para cargar datos desde localStorage
    function loadData() {
      try {
        companies = JSON.parse(localStorage.getItem('companies') || '[]');
        brands = JSON.parse(localStorage.getItem('brands') || '[]');
        tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
        subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');
        credentials = JSON.parse(localStorage.getItem('credentials') || '[]');
        documents = JSON.parse(localStorage.getItem('documents') || '[]');
        memoriaContable = JSON.parse(localStorage.getItem('memoriaContable') || '[]');
        notas = JSON.parse(localStorage.getItem('notas') || '[]');
        
        console.log('üìÇ Datos cargados desde localStorage:');
        console.log(`  ‚Ä¢ ${companies.length} empresas`);
        console.log(`  ‚Ä¢ ${brands.length} marcas`);
        console.log(`  ‚Ä¢ ${tasks.length} tareas`);
        console.log(`  ‚Ä¢ ${subscriptions.length} suscripciones`);
        console.log(`  ‚Ä¢ ${credentials.length} credenciales`);
        console.log(`  ‚Ä¢ ${documents.length} documentos`);
        console.log(`  ‚Ä¢ ${memoriaContable.length} entradas de memoria contable`);
        console.log(`  ‚Ä¢ ${notas.length} notas`);
      } catch (error) {
        console.error('‚ùå Error cargando datos:', error);
      }
    }

    // Funci√≥n para guardar datos en localStorage
    function saveData() {
      try {
        localStorage.setItem('companies', JSON.stringify(companies));
        localStorage.setItem('brands', JSON.stringify(brands));
        localStorage.setItem('tasks', JSON.stringify(tasks));
        localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
        localStorage.setItem('credentials', JSON.stringify(credentials));
        localStorage.setItem('documents', JSON.stringify(documents));
        localStorage.setItem('memoriaContable', JSON.stringify(memoriaContable));
        localStorage.setItem('notas', JSON.stringify(notas));
        
        console.log('üíæ Datos guardados en localStorage:');
        console.log(`  ‚Ä¢ ${companies.length} empresas`);
        console.log(`  ‚Ä¢ ${brands.length} marcas`);
        console.log(`  ‚Ä¢ ${tasks.length} tareas`);
        console.log(`  ‚Ä¢ ${subscriptions.length} suscripciones`);
        console.log(`  ‚Ä¢ ${credentials.length} credenciales`);
        console.log(`  ‚Ä¢ ${documents.length} documentos`);
        console.log(`  ‚Ä¢ ${memoriaContable.length} entradas de memoria contable`);
        console.log(`  ‚Ä¢ ${notas.length} notas`);
      } catch (error) {
        console.error('‚ùå Error guardando datos:', error);
      }
    }

    // Funci√≥n para cargar configuraci√≥n
    function loadConfig() {
      try {
        config = JSON.parse(localStorage.getItem('config') || '{}');

        // Aplicar configuraci√≥n si existe
        if (config.centerName) {
          const nameEl = document.getElementById('center-name');
          if (nameEl) nameEl.textContent = config.centerName;
        }
        if (config.centerSubtitle) {
          const subtitleEl = document.getElementById('center-subtitle');
          if (subtitleEl) subtitleEl.textContent = config.centerSubtitle;
        }
      } catch (error) {
        console.error('Error cargando configuraci√≥n:', error);
      }
    }

    // Funciones b√°sicas de CRUD para tareas
    function toggleTask(id) {
      const task = tasks.find(t => t.id === id);
      if (task) {
        task.completed = !task.completed;
        saveData();
        renderTareas();
        renderDashboard();
      }
    }

    async function deleteTask(id) {
      if (confirm('¬øEst√°s seguro de que deseas eliminar esta tarea?')) {
        try {
          if (supabase && SUPABASE_CONFIG.enabled) {
            await deleteFromSupabase(id, 'tasks');
          }
          tasks = tasks.filter(t => t.id !== id);
          saveData();
          renderTareas();
          renderDashboard();
          console.log('‚úÖ Tarea eliminada correctamente');
        } catch (error) {
          console.error('‚ùå Error eliminando tarea:', error);
          alert('Error eliminando tarea. Revisa la consola.');
        }
      }
    }

    // Funciones b√°sicas para empresas
    async function deleteEmpresa(id) {
      if (confirm('¬øEst√°s seguro de que deseas eliminar esta empresa?')) {
        try {
          // Eliminar de Supabase primero
          if (supabase && SUPABASE_CONFIG.enabled) {
            await deleteFromSupabase(id, 'companies');
          }

          // Eliminar del array local
          companies = companies.filter(c => c.id !== id);
          saveData();
          renderEmpresas();

          console.log('‚úÖ Empresa eliminada correctamente');
        } catch (error) {
          console.error('‚ùå Error eliminando empresa:', error);
          alert('Error eliminando empresa. Revisa la consola.');
        }
      }
    }

    // Funciones b√°sicas para marcas
    async function deleteMarca(id) {
      if (confirm('¬øEst√°s seguro de que deseas eliminar esta marca?')) {
        try {
          // Eliminar de Supabase primero
          if (supabase && SUPABASE_CONFIG.enabled) {
            await deleteFromSupabase(id, 'brands');
          }

          // Eliminar del array local
          brands = brands.filter(b => b.id !== id);
          saveData();
          renderMarcas();

          console.log('‚úÖ Marca eliminada correctamente');
        } catch (error) {
          console.error('‚ùå Error eliminando marca:', error);
          alert('Error eliminando marca. Revisa la consola.');
        }
      }
    }

    // Funciones b√°sicas para suscripciones
    async function deleteSubscription(id) {
      if (confirm('¬øEst√°s seguro de que deseas eliminar esta suscripci√≥n?')) {
        try {
          if (supabase && SUPABASE_CONFIG.enabled) {
            await deleteFromSupabase(id, 'subscriptions');
          }
          subscriptions = subscriptions.filter(s => s.id !== id);
          saveData();
          renderSuscripciones();
          console.log('‚úÖ Suscripci√≥n eliminada correctamente');
        } catch (error) {
          console.error('‚ùå Error eliminando suscripci√≥n:', error);
          alert('Error eliminando suscripci√≥n. Revisa la consola.');
        }
      }
    }

    // Funciones b√°sicas para credenciales
    async function deleteCredential(id) {
      if (confirm('¬øEst√°s seguro de que deseas eliminar esta credencial?')) {
        try {
          if (supabase && SUPABASE_CONFIG.enabled) {
            await deleteFromSupabase(id, 'credentials');
          }
          credentials = credentials.filter(c => c.id !== id);
          saveData();
          renderCredenciales();
          console.log('‚úÖ Credencial eliminada correctamente');
        } catch (error) {
          console.error('‚ùå Error eliminando credencial:', error);
          alert('Error eliminando credencial. Revisa la consola.');
        }
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('Credencial copiada al portapapeles');
      }).catch(() => {
        // Fallback para navegadores antiguos
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Credencial copiada al portapapeles');
      });
    }

    // Funciones b√°sicas para documentos
    async function deleteDocument(id) {
      if (confirm('¬øEst√°s seguro de que deseas eliminar este documento?')) {
        try {
          if (supabase && SUPABASE_CONFIG.enabled) {
            await deleteFromSupabase(id, 'documents');
          }
          documents = documents.filter(d => d.id !== id);
          saveData();
          renderDocumentos();
          console.log('‚úÖ Documento eliminado correctamente');
        } catch (error) {
          console.error('‚ùå Error eliminando documento:', error);
          alert('Error eliminando documento. Revisa la consola.');
        }
      }
    }

    // Funci√≥n de b√∫squeda global
    function globalSearch(query) {
      const searchResults = document.getElementById('search-results');
      if (!searchResults) return;

      if (!query.trim()) {
        searchResults.style.display = 'none';
        return;
      }

      const results = [];
      const searchTerm = query.toLowerCase();

      // Buscar en empresas
      companies.forEach(company => {
        if (company.name?.toLowerCase().includes(searchTerm) ||
          company.legalName?.toLowerCase().includes(searchTerm) ||
          company.cif?.toLowerCase().includes(searchTerm)) {
          results.push({
            type: 'Empresa',
            title: company.name,
            subtitle: company.legalName || company.cif,
            action: () => { showView('empresas'); searchResults.style.display = 'none'; }
          });
        }
      });

      // Buscar en marcas
      brands.forEach(brand => {
        if (brand.name?.toLowerCase().includes(searchTerm) ||
          brand.domain?.toLowerCase().includes(searchTerm)) {
          results.push({
            type: 'Marca',
            title: brand.name,
            subtitle: brand.domain || brand.type,
            action: () => { showView('marcas'); searchResults.style.display = 'none'; }
          });
        }
      });

      // Buscar en tareas
      tasks.forEach(task => {
        if (task.description?.toLowerCase().includes(searchTerm)) {
          results.push({
            type: 'Tarea',
            title: task.description,
            subtitle: task.date || 'Sin fecha',
            action: () => { showView('tareas'); searchResults.style.display = 'none'; }
          });
        }
      });

      if (results.length > 0) {
        searchResults.innerHTML = results.map(result => `
          <div class="search-result" onclick="handleSearchResult('${result.type}', '${result.title}')" style="padding: 12px; border-bottom: 1px solid #1A1A1A; cursor: pointer; hover:background: #1A1A1A;">
            <div style="font-size: 14px; font-weight: 500;">${result.title}</div>
            <div style="font-size: 12px; color: #888;">${result.type} ‚Ä¢ ${result.subtitle}</div>
          </div>
        `).join('');
        searchResults.style.display = 'block';
      } else {
        searchResults.innerHTML = '<div style="padding: 12px; color: #888; text-align: center;">No se encontraron resultados</div>';
        searchResults.style.display = 'block';
      }
    }

    function handleSearchResult(type, title) {
      const searchResults = document.getElementById('search-results');
      if (searchResults) {
        searchResults.style.display = 'none';
      }

      // Limpiar b√∫squeda
      const searchInput = document.getElementById('global-search');
      if (searchInput) {
        searchInput.value = '';
      }

      // Navegar a la vista correspondiente
      switch (type) {
        case 'Empresa':
          showView('empresas');
          break;
        case 'Marca':
          showView('marcas');
          break;
        case 'Tarea':
          showView('tareas');
          break;
      }
    }
  </script>
</body>

</html>