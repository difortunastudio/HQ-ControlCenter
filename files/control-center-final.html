<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control Center - HQ Completo</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Supabase CDN - cargado desde el head para garantizar disponibilidad -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
    }

    .header {
      position: sticky;
      top: 0;
      z-index: 50;
      border-bottom: 1px solid #1F1F1F;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      padding: 16px 20px;
    }

    .header-title {
      font-size: 18px;
      font-weight: 600;
    }

    .header-subtitle {
      font-size: 12px;
      color: #888;
      margin-top: 2px;
    }

    .nav {
      display: flex;
      gap: 8px;
      padding: 12px 20px;
      overflow-x: auto;
      border-bottom: 1px solid #1F1F1F;
    }

    .nav::-webkit-scrollbar { display: none; }

    .nav-btn {
      background: transparent;
      border: none;
      color: #888;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.15s;
    }

    .nav-btn:hover,
    .nav-btn.active {
      background: #1A1A1A;
      color: #fff;
    }

    .content {
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #666;
    }

    .btn-add {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: #1A1A1A;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
    }

    .btn-add:hover {
      background: #252525;
    }

    .btn-back {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: #1A1A1A;
      border: none;
      border-radius: 8px;
      color: #888;
      font-size: 13px;
      cursor: pointer;
      margin-bottom: 20px;
      transition: all 0.15s;
    }

    .btn-back:hover {
      background: #252525;
      color: #fff;
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    .grid-2 {
      grid-template-columns: 1fr;
    }

    .grid-3 {
      grid-template-columns: 1fr;
    }

    @media (min-width: 600px) {
      .grid-2 { grid-template-columns: repeat(2, 1fr); }
      .grid-3 { grid-template-columns: repeat(3, 1fr); }
    }

    .card {
      background: #0D0D0D;
      border: 1px solid #1A1A1A;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.2s;
    }

    .card-clickable {
      cursor: pointer;
    }

    .card-clickable:hover {
      border-color: #333;
      transform: translateY(-2px);
    }

    .stat-card {
      text-align: center;
    }

    .stat-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .stat-label {
      font-size: 13px;
      color: #888;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
    }

    .company-logo, .brand-logo {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      background: #1A1A1A;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .brand-logo {
      width: 50px;
      height: 50px;
      font-size: 20px;
    }

    .info-section {
      background: #0D0D0D;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .info-section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #1A1A1A;
      font-size: 13px;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: #888;
    }

    .info-value {
      color: #fff;
      text-align: right;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
    }

    .status-activa { background: rgba(74, 222, 128, 0.15); color: #4ADE80; }
    .status-desarrollo { background: rgba(251, 191, 36, 0.15); color: #FBBF24; }
    .status-concepto { background: rgba(167, 139, 250, 0.15); color: #A78BFA; }
    .status-pausa { background: rgba(248, 113, 113, 0.15); color: #F87171; }

    .cost-badge {
      padding: 6px 12px;
      background: #1A1A1A;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      color: #4ADE80;
    }

    .service-item {
      background: #1A1A1A;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .service-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .service-name {
      font-size: 14px;
      font-weight: 500;
    }

    .service-meta {
      font-size: 12px;
      color: #888;
    }

    .renewal-badge {
      padding: 4px 8px;
      background: rgba(251, 191, 36, 0.15);
      color: #FBBF24;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
    }

    .tag {
      display: inline-block;
      padding: 4px 10px;
      background: #1A1A1A;
      border-radius: 6px;
      font-size: 11px;
      color: #888;
      margin-right: 6px;
      margin-bottom: 6px;
    }

    .alert-box {
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .alert-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #FBBF24;
      margin-bottom: 12px;
    }

    .alert-item {
      font-size: 13px;
      color: #C8C8C8;
      padding: 8px 0;
      border-bottom: 1px solid rgba(251, 191, 36, 0.1);
    }

    .alert-item:last-child {
      border-bottom: none;
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #0D0D0D;
      border: 1px solid #1A1A1A;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: #888;
      cursor: pointer;
      padding: 4px;
      font-size: 24px;
      line-height: 1;
    }

    .modal-close:hover {
      color: #fff;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      color: #888;
      margin-bottom: 6px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 10px 12px;
      background: #1A1A1A;
      border: 1px solid #252525;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      font-family: inherit;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #fff;
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-actions {
      display: flex;
      gap: 8px;
      margin-top: 24px;
    }

    .btn-cancel,
    .btn-submit {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-cancel {
      background: #1A1A1A;
      color: #fff;
    }

    .btn-cancel:hover {
      background: #252525;
    }

    .btn-submit {
      background: #fff;
      color: #000;
    }

    .btn-submit:hover {
      background: #e5e5e5;
    }

    .dynamic-field {
      background: #1A1A1A;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      position: relative;
    }

    .dynamic-field-remove {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      padding: 4px;
    }

    .dynamic-field-remove:hover {
      color: #F87171;
    }

    .dynamic-field .form-group {
      margin-bottom: 8px;
    }

    .dynamic-field .form-group:last-child {
      margin-bottom: 0;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .tag-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      margin-right: 6px;
      margin-bottom: 6px;
    }

    .tag-item button {
      background: transparent;
      border: none;
      color: currentColor;
      opacity: 0.7;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
      margin-left: 4px;
    }

    .tag-item button:hover {
      opacity: 1;
    }

    .tag-input-wrapper {
      background: #1A1A1A;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .tag-input-wrapper input {
      flex: 1;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 13px;
      outline: none;
    }

    .tag-input-wrapper button {
      padding: 6px 12px;
      background: #252525;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
    }

    .tag-input-wrapper button:hover {
      background: #333;
    }
  </style>
</head>
<body>

  <header class="header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div style="flex: 1;">
        <h1 class="header-title" id="center-name">FGD VII ‚Äî Control Center</h1>
        <p class="header-subtitle" id="center-subtitle">Empresas ¬∑ Marcas ¬∑ Suscripciones ¬∑ Credenciales</p>
      </div>
      <div style="position: relative; margin-right: 16px;">
        <input 
          type="text" 
          id="global-search" 
          placeholder="üîç Buscar..."
          style="padding: 10px 16px; background: #1A1A1A; border: 1px solid #252525; border-radius: 8px; color: #fff; font-size: 14px; width: 300px;"
          onkeyup="globalSearch(this.value)"
        >
        <div id="search-results" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: #0D0D0D; border: 1px solid #1A1A1A; border-radius: 8px; width: 400px; max-height: 400px; overflow-y: auto; z-index: 100;"></div>
      </div>
      <button onclick="openModal('config')" style="padding: 10px 16px; background: #1A1A1A; border: 1px solid #252525; border-radius: 8px; color: #fff; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; white-space: nowrap;">
        ‚öôÔ∏è Mi perfil
      </button>
    </div>
  </header>

  <nav class="nav">
    <button class="nav-btn active" data-view="dashboard">Dashboard</button>
    <button class="nav-btn" data-view="tareas">Tareas</button>
    <button class="nav-btn" data-view="empresas">Empresas</button>
    <button class="nav-btn" data-view="marcas">Marcas</button>
    <button class="nav-btn" data-view="documentos">Documentos</button>
    <button class="nav-btn" data-view="suscripciones">Suscripciones</button>
    <button class="nav-btn" data-view="credenciales">Credenciales</button>
  </nav>

  <main class="content">

    <!-- DASHBOARD -->
    <div id="dashboard" class="view active">
      
      <!-- Alertas de renovaci√≥n -->
      <div class="alert-box">
        <div class="alert-title">
          ‚ö†Ô∏è Pr√≥ximas renovaciones (este mes)
        </div>
        <div class="alert-item">
          <strong>Google Workspace</strong> (5‚Ç¨) - Renueva d√≠a 18
        </div>
        <div class="alert-item">
          <strong>fliia.app</strong> - Renueva en 45 d√≠as
        </div>
      </div>

      <div class="grid grid-3">
        <div class="card stat-card">
          <div class="stat-icon">üìã</div>
          <div class="stat-label">Tareas de hoy</div>
          <div class="stat-value" id="tasks-today">0</div>
        </div>
        <div class="card stat-card">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-label">Completadas</div>
          <div class="stat-value" id="tasks-completed">0</div>
        </div>
        <div class="card stat-card">
          <div class="stat-icon">‚è∞</div>
          <div class="stat-label">Pendientes</div>
          <div class="stat-value" id="tasks-pending">0</div>
        </div>
      </div>

      <div style="margin-top: 24px;">
        <div class="section-title" style="margin-bottom: 16px;">Accesos r√°pidos</div>
        <div class="grid grid-3">
          <div class="card card-clickable" onclick="document.querySelector('[data-view=\\'empresas\\']').click()">
            <div style="font-size: 32px; margin-bottom: 8px;">üè¢</div>
            <div style="font-size: 14px; font-weight: 500;">Ver Empresas</div>
            <div style="font-size: 12px; color: #888;">Gestionar empresas</div>
          </div>
          <div class="card card-clickable" onclick="document.querySelector('[data-view=\\'marcas\\']').click()">
            <div style="font-size: 32px; margin-bottom: 8px;">üè∑</div>
            <div style="font-size: 14px; font-weight: 500;">Ver Marcas</div>
            <div style="font-size: 12px; color: #888;">Todas las marcas</div>
          </div>
          <div class="card card-clickable" onclick="openModal('tarea')">
            <div style="font-size: 32px; margin-bottom: 8px;">‚ûï</div>
            <div style="font-size: 14px; font-weight: 500;">Nueva Tarea</div>
            <div style="font-size: 12px; color: #888;">Agregar tarea r√°pida</div>
          </div>
        </div>
      </div>

      <div style="margin-top: 24px;">
        <div class="section-title" style="margin-bottom: 16px;">Tareas de hoy</div>
        <div id="dashboard-tasks-today"></div>
      </div>

      <div style="margin-top: 24px;">
        <div class="section-title" style="margin-bottom: 16px;">Actividad reciente</div>
        <div id="dashboard-activity"></div>
      </div>

    </div>

    <!-- TAREAS -->
    <div id="tareas" class="view">
      <div class="section-header">
        <h2 class="section-title">Mis tareas</h2>
        <button class="btn-add" onclick="openModal('tarea')">+ Nueva tarea</button>
      </div>
      <div id="tareas-list"></div>
    </div>

    <!-- EMPRESAS -->
    <div id="empresas" class="view">
      <div class="section-header">
        <h2 class="section-title">Mis empresas</h2>
        <button class="btn-add" onclick="openModal('empresa')">+ Nueva empresa</button>
      </div>
      <div class="grid grid-2" id="empresas-list"></div>
    </div>

    <!-- DOCUMENTOS -->
    <div id="documentos" class="view">
      <div class="section-header">
        <h2 class="section-title">Documentos</h2>
        <button class="btn-add" onclick="openModal('documento')">+ Nuevo documento</button>
      </div>
      <div id="documentos-list"></div>
    </div>

    <!-- DETALLE EMPRESA -->
    <div id="empresa-detalle" class="view">
      <button class="btn-back" onclick="goBack()">‚Üê Volver a empresas</button>
      <div id="empresa-detalle-content"></div>
    </div>

    <!-- MARCAS -->
    <div id="marcas" class="view">
      <div class="section-header">
        <h2 class="section-title">Todas las marcas</h2>
        <button class="btn-add" onclick="openModal('marca')">+ Nueva marca</button>
      </div>
      <div class="grid grid-2" id="marcas-list"></div>
    </div>

    <!-- DETALLE MARCA -->
    <div id="marca-detalle" class="view">
      <button class="btn-back" onclick="goBack()">‚Üê Volver a marcas</button>
      <div id="marca-detalle-content"></div>
    </div>

    <!-- SUSCRIPCIONES -->
    <div id="suscripciones" class="view">
      <div class="section-header">
        <h2 class="section-title">Todas las suscripciones</h2>
        <button class="btn-add" onclick="openModal('suscripcion')">+ Nueva suscripci√≥n</button>
      </div>
      <div id="suscripciones-list"></div>
    </div>

    <!-- CREDENCIALES -->
    <div id="credenciales" class="view">
      <div class="section-header">
        <h2 class="section-title">Todas las credenciales</h2>
        <button class="btn-add" onclick="openModal('credencial')">+ Nueva credencial</button>
      </div>
      <div id="credenciales-list"></div>
    </div>

  </main>

  <script>
    // ============================================
    // CONFIGURACI√ìN DE SUPABASE
    // ============================================
    
    // Configuraci√≥n de Supabase
    const SUPABASE_CONFIG = {
      enabled: true, // ‚úÖ Supabase configurado y habilitado
      url: 'https://fbhdpwedkdbyectmieeh.supabase.co', // Tu URL de Supabase
      anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZiaGRwd2Vka2RieWVjdG1pZWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2OTgwMzYsImV4cCI6MjA4NTI3NDAzNn0.bCwnZNNM4o1N_WC-8M0t_1eaID_pxszgRrZNflxBaLk', // Tu clave an√≥nima de Supabase
      realTimeSync: true // Sincronizaci√≥n en tiempo real
    };

    let supabase = null;
    let supabaseSubscriptions = [];

    // ============================================
    // VARIABLES GLOBALES DE DATOS
    // ============================================
    let companies = [];
    let brands = [];
    let tasks = [];
    let subscriptions = [];
    let credentials = [];
    let documents = [];
    let memoriaContable = [];

    // ============================================
    // AUTENTICACI√ìN
    // ============================================
    const authConfig = {
      username: 'admin',
      password: 'control2026'
    };

    let isAuthenticated = false;

    function checkAuth() {
      const savedAuth = localStorage.getItem('controlCenterAuth');
      if (savedAuth) {
        const authData = JSON.parse(savedAuth);
        const now = new Date().getTime();
        // Sesi√≥n v√°lida por 24 horas
        if (authData.timestamp && (now - authData.timestamp) < 24 * 60 * 60 * 1000) {
          isAuthenticated = true;
          showMainApp();
        } else {
          localStorage.removeItem('controlCenterAuth');
          showLoginScreen();
        }
      } else {
        showLoginScreen();
      }
    }

    function showLoginScreen() {
      document.body.innerHTML = `
        <div style="
          display: flex;
          justify-content: center;
          align-items: center;
          min-height: 100vh;
          background: linear-gradient(135deg, #0F0F0F 0%, #1A1A1A 100%);
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        ">
          <div style="
            background: #1A1A1A;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border: 1px solid #333;
            width: 100%;
            max-width: 400px;
            text-align: center;
          ">
            <div style="
              width: 80px;
              height: 80px;
              background: linear-gradient(135deg, #4ADE80 0%, #22C55E 100%);
              border-radius: 20px;
              display: flex;
              align-items: center;
              justify-content: center;
              margin: 0 auto 24px;
              font-size: 32px;
              font-weight: 700;
              color: white;
            ">CC</div>
            
            <h1 style="
              color: white;
              font-size: 28px;
              font-weight: 700;
              margin: 0 0 8px 0;
            ">Control Center</h1>
            
            <p style="
              color: #888;
              font-size: 14px;
              margin: 0 0 32px 0;
            ">Acceso seguro al sistema</p>
            
            <form id="login-form" style="text-align: left;">
              <div style="margin-bottom: 20px;">
                <label style="
                  display: block;
                  color: #C8C8C8;
                  font-size: 13px;
                  font-weight: 500;
                  margin-bottom: 6px;
                ">Usuario</label>
                <input 
                  type="text" 
                  id="username" 
                  required
                  style="
                    width: 100%;
                    padding: 12px 16px;
                    background: #0D0D0D;
                    border: 1px solid #333;
                    border-radius: 8px;
                    color: white;
                    font-size: 14px;
                    box-sizing: border-box;
                  "
                  placeholder="Ingresa tu usuario"
                />
              </div>
              
              <div style="margin-bottom: 24px;">
                <label style="
                  display: block;
                  color: #C8C8C8;
                  font-size: 13px;
                  font-weight: 500;
                  margin-bottom: 6px;
                ">Contrase√±a</label>
                <input 
                  type="password" 
                  id="password" 
                  required
                  style="
                    width: 100%;
                    padding: 12px 16px;
                    background: #0D0D0D;
                    border: 1px solid #333;
                    border-radius: 8px;
                    color: white;
                    font-size: 14px;
                    box-sizing: border-box;
                  "
                  placeholder="Ingresa tu contrase√±a"
                />
              </div>
              
              <button 
                type="submit"
                style="
                  width: 100%;
                  padding: 14px;
                  background: linear-gradient(135deg, #4ADE80 0%, #22C55E 100%);
                  border: none;
                  border-radius: 8px;
                  color: white;
                  font-size: 14px;
                  font-weight: 600;
                  cursor: pointer;
                  transition: all 0.2s;
                "
                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(74, 222, 128, 0.3)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
              >
                Iniciar Sesi√≥n
              </button>
            </form>
            
            <div id="login-error" style="
              color: #F87171;
              font-size: 13px;
              margin-top: 16px;
              display: none;
            "></div>
            
            <div style="
              margin-top: 32px;
              padding-top: 20px;
              border-top: 1px solid #333;
              color: #666;
              font-size: 12px;
            ">
              <strong>Credenciales por defecto:</strong><br>
              Usuario: admin<br>
              Contrase√±a: control2026
            </div>
          </div>
        </div>
      `;

      document.getElementById('login-form').addEventListener('submit', handleLogin);
    }

    function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('login-error');

      if (username === authConfig.username && password === authConfig.password) {
        // Guardar autenticaci√≥n
        const authData = {
          authenticated: true,
          timestamp: new Date().getTime()
        };
        localStorage.setItem('controlCenterAuth', JSON.stringify(authData));
        
        isAuthenticated = true;
        showMainApp();
      } else {
        errorDiv.textContent = 'Usuario o contrase√±a incorrectos';
        errorDiv.style.display = 'block';
        
        // Limpiar error despu√©s de 3 segundos
        setTimeout(() => {
          errorDiv.style.display = 'none';
        }, 3000);
      }
    }

    function logout() {
      localStorage.removeItem('controlCenterAuth');
      isAuthenticated = false;
      location.reload();
    }

    async function showMainApp() {
      // Restaurar el HTML original de la aplicaci√≥n
      document.body.innerHTML = getMainAppHTML() + getModalsHTML();
      
      // Cargar datos desde localStorage primero (r√°pido)
      loadData();
      loadConfig();
      
      // Inicializar la interfaz
      initializeApp();
      
      // Inicializar Supabase si est√° habilitado (script ya cargado desde el head)
      if (SUPABASE_CONFIG.enabled && SUPABASE_CONFIG.url && SUPABASE_CONFIG.anonKey) {
        // Verificar que Supabase est√© disponible
        if (typeof window.supabase === 'object' && window.supabase.createClient) {
          console.log('üì¶ Supabase disponible, inicializando...');
          const supabaseInitialized = initializeSupabase();
          
          // Si Supabase se inicializ√≥ correctamente, cargar datos desde la nube
          if (supabaseInitialized && supabase) {
            console.log('üåê Cargando datos desde Supabase...');
            await loadFromSupabase();
            
            // Re-renderizar con los datos actualizados
            renderDashboard();
            renderTareas();
            renderEmpresas();
            renderMarcas();
            renderSuscripciones();
            renderCredenciales();
            renderDocumentos();
            
            console.log('‚úÖ Aplicaci√≥n sincronizada con Supabase');
          }
        } else {
          console.error('‚ùå Supabase no disponible, usando solo localStorage');
          console.log('üîç window.supabase:', window.supabase);
        }
      }
    }

    function getMainAppHTML() {
      return `
        <header class="header">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
              <h1 class="header-title" id="center-name">FGD VII ‚Äî Control Center</h1>
              <p class="header-subtitle" id="center-subtitle">Empresas ¬∑ Marcas ¬∑ Suscripciones ¬∑ Credenciales</p>
            </div>
            <div style="position: relative; margin-right: 16px;">
              <input 
                type="text" 
                id="global-search" 
                placeholder="üîç Buscar..."
                style="padding: 10px 16px; background: #1A1A1A; border: 1px solid #252525; border-radius: 8px; color: #fff; font-size: 14px; width: 300px;"
                onkeyup="globalSearch(this.value)"
              >
              <div id="search-results" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: #0D0D0D; border: 1px solid #1A1A1A; border-radius: 8px; width: 400px; max-height: 400px; overflow-y: auto; z-index: 100;"></div>
            </div>
            <div style="display: flex; gap: 12px;">
              <button onclick="openModal('config')" style="padding: 10px 16px; background: #1A1A1A; border: 1px solid #252525; border-radius: 8px; color: #fff; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; white-space: nowrap;">
                ‚öôÔ∏è Mi perfil
              </button>
              <button onclick="logout()" style="padding: 10px 16px; background: #1A1A1A; border: 1px solid #252525; border-radius: 8px; color: #fff; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; white-space: nowrap;">
                üö™ Salir
              </button>
            </div>
          </div>
        </header>

        <nav class="nav">
          <button class="nav-btn active" data-view="dashboard">Dashboard</button>
          <button class="nav-btn" data-view="tareas">Tareas</button>
          <button class="nav-btn" data-view="empresas">Empresas</button>
          <button class="nav-btn" data-view="marcas">Marcas</button>
          <button class="nav-btn" data-view="documentos">Documentos</button>
          <button class="nav-btn" data-view="suscripciones">Suscripciones</button>
          <button class="nav-btn" data-view="credenciales">Credenciales</button>
        </nav>

        <main class="content">

          <!-- DASHBOARD -->
          <div id="dashboard" class="view active">
            
            <!-- Alertas de renovaci√≥n -->
            <div class="alert-box">
              <div class="alert-title">
                ‚ö†Ô∏è Pr√≥ximas renovaciones (este mes)
              </div>
              <div class="alert-item">
                <strong>Google Workspace</strong> (5‚Ç¨) - Renueva d√≠a 18
              </div>
              <div class="alert-item">
                <strong>fliia.app</strong> - Renueva en 45 d√≠as
              </div>
            </div>

            <div class="grid grid-3">
              <div class="card stat-card">
                <div class="stat-icon">üìã</div>
                <div class="stat-label">Tareas de hoy</div>
                <div class="stat-value" id="tasks-today">0</div>
              </div>
              <div class="card stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-label">Completadas</div>
                <div class="stat-value" id="tasks-completed">0</div>
              </div>
              <div class="card stat-card">
                <div class="stat-icon">‚è∞</div>
                <div class="stat-label">Pendientes</div>
                <div class="stat-value" id="tasks-pending">0</div>
              </div>
            </div>

            <div style="margin-top: 24px;">
              <div class="section-title" style="margin-bottom: 16px;">Accesos r√°pidos</div>
              <div class="grid grid-3">
                <div class="card card-clickable" onclick="document.querySelector('[data-view=\\'empresas\\']').click()">
                  <div style="font-size: 32px; margin-bottom: 8px;">üè¢</div>
                  <div style="font-size: 14px; font-weight: 500;">Ver Empresas</div>
                  <div style="font-size: 12px; color: #888;">Gestionar empresas</div>
                </div>
                <div class="card card-clickable" onclick="document.querySelector('[data-view=\\'marcas\\']').click()">
                  <div style="font-size: 32px; margin-bottom: 8px;">üè∑</div>
                  <div style="font-size: 14px; font-weight: 500;">Ver Marcas</div>
                  <div style="font-size: 12px; color: #888;">Todas las marcas</div>
                </div>
                <div class="card card-clickable" onclick="openModal('tarea')">
                  <div style="font-size: 32px; margin-bottom: 8px;">‚ûï</div>
                  <div style="font-size: 14px; font-weight: 500;">Nueva Tarea</div>
                  <div style="font-size: 12px; color: #888;">Agregar tarea r√°pida</div>
                </div>
              </div>
            </div>

            <div style="margin-top: 24px;">
              <div class="section-title" style="margin-bottom: 16px;">Tareas de hoy</div>
              <div id="dashboard-tasks-today"></div>
            </div>

            <div style="margin-top: 24px;">
              <div class="section-title" style="margin-bottom: 16px;">Actividad reciente</div>
              <div id="dashboard-activity"></div>
            </div>

          </div>

          <!-- TAREAS -->
          <div id="tareas" class="view">
            <div class="section-header">
              <h2 class="section-title">Mis tareas</h2>
              <button class="btn-add" onclick="openModal('tarea')">+ Nueva tarea</button>
            </div>
            <div id="tareas-list"></div>
          </div>

          <!-- EMPRESAS -->
          <div id="empresas" class="view">
            <div class="section-header">
              <h2 class="section-title">Mis empresas</h2>
              <button class="btn-add" onclick="openModal('empresa')">+ Nueva empresa</button>
            </div>
            <div class="grid grid-2" id="empresas-list"></div>
          </div>

          <!-- DOCUMENTOS -->
          <div id="documentos" class="view">
            <div class="section-header">
              <h2 class="section-title">Documentos</h2>
              <button class="btn-add" onclick="openModal('documento')">+ Nuevo documento</button>
            </div>
            <div id="documentos-list"></div>
          </div>

          <!-- DETALLE EMPRESA -->
          <div id="empresa-detalle" class="view">
            <button class="btn-back" onclick="goBack()">‚Üê Volver a empresas</button>
            <div id="empresa-detalle-content"></div>
          </div>

          <!-- MARCAS -->
          <div id="marcas" class="view">
            <div class="section-header">
              <h2 class="section-title">Todas las marcas</h2>
              <button class="btn-add" onclick="openModal('marca')">+ Nueva marca</button>
            </div>
            <div class="grid grid-2" id="marcas-list"></div>
          </div>

          <!-- DETALLE MARCA -->
          <div id="marca-detalle" class="view">
            <button class="btn-back" onclick="goBack()">‚Üê Volver a marcas</button>
            <div id="marca-detalle-content"></div>
          </div>

          <!-- SUSCRIPCIONES -->
          <div id="suscripciones" class="view">
            <div class="section-header">
              <h2 class="section-title">Todas las suscripciones</h2>
              <button class="btn-add" onclick="openModal('suscripcion')">+ Nueva suscripci√≥n</button>
            </div>
            <div id="suscripciones-list"></div>
          </div>

          <!-- CREDENCIALES -->
          <div id="credenciales" class="view">
            <div class="section-header">
              <h2 class="section-title">Todas las credenciales</h2>
              <button class="btn-add" onclick="openModal('credencial')">+ Nueva credencial</button>
            </div>
            <div id="credenciales-list"></div>
          </div>

        </main>
      `;
    }

    function getModalsHTML() {
      return `
        <!-- Modales -->
        <div id="modal-empresa" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Nueva empresa</h3>
              <button class="modal-close" onclick="closeModal('empresa')">√ó</button>
            </div>
            <form id="form-empresa" onsubmit="submitEmpresa(event)">
              
              <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; margin-bottom: 16px; letter-spacing: 1px;">Informaci√≥n b√°sica</div>
              
              <div class="form-group">
                <label class="form-label">Nombre comercial *</label>
                <input type="text" name="name" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Nombre legal / Raz√≥n social</label>
                <input type="text" name="legalName" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">CIF/NIF</label>
                <input type="text" name="cif" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Direcci√≥n fiscal</label>
                <input type="text" name="fiscalAddress" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Tel√©fono principal</label>
                <input type="tel" name="phone" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Email principal</label>
                <input type="email" name="email" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Etiquetas (separadas por comas)</label>
                <input type="text" name="tags" class="form-input" placeholder="Activa, Principal, Fiscal 2024">
                <div style="font-size: 11px; color: #666; margin-top: 4px;">Escribe etiquetas separadas por comas. Ej: Activa, Principal, Holding</div>
              </div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; letter-spacing: 1px;">Cuentas bancarias</div>
                <button type="button" onclick="addBankAccount()" style="padding: 4px 10px; background: #1A1A1A; border: none; border-radius: 6px; color: #fff; font-size: 12px; cursor: pointer;">+ Agregar</button>
              </div>
              <div id="bank-accounts-container"></div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; letter-spacing: 1px;">Correos corporativos</div>
                <button type="button" onclick="addEmail()" style="padding: 4px 10px; background: #1A1A1A; border: none; border-radius: 6px; color: #fff; font-size: 12px; cursor: pointer;">+ Agregar</button>
              </div>
              <div id="emails-container"></div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; letter-spacing: 1px;">Redes sociales</div>
                <button type="button" onclick="addSocialMedia()" style="padding: 4px 10px; background: #1A1A1A; border: none; border-radius: 6px; color: #fff; font-size: 12px; cursor: pointer;">+ Agregar</button>
              </div>
              <div id="social-media-container"></div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div class="form-group">
                <label class="form-label">Notas</label>
                <textarea name="notes" class="form-textarea" placeholder="Cualquier informaci√≥n adicional relevante..."></textarea>
              </div>

              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('empresa')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar empresa</button>
              </div>
            </form>
          </div>
        </div>

        <div id="modal-marca" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Nueva marca</h3>
              <button class="modal-close" onclick="closeModal('marca')">√ó</button>
            </div>
            <form id="form-marca" onsubmit="submitMarca(event)">
              
              <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; margin-bottom: 16px; letter-spacing: 1px;">Informaci√≥n b√°sica</div>
              
              <div class="form-group">
                <label class="form-label">Nombre *</label>
                <input type="text" name="name" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Tipo</label>
                <input type="text" name="type" class="form-input" placeholder="App, Servicio, Producto, etc">
              </div>
              <div class="form-group">
                <label class="form-label">Facturada por *</label>
                <select name="companyId" class="form-select" required>
                  <option value="">Seleccionar empresa...</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Etiquetas (separadas por comas)</label>
                <input type="text" name="tags" class="form-input" placeholder="Activa, SaaS, Prioritario, Q1 2026">
                <div style="font-size: 11px; color: #666; margin-top: 4px;">Escribe etiquetas separadas por comas. Ej: Activa, Beta, Revenue</div>
              </div>
              <div class="form-group">
                <label class="form-label">Servicios</label>
                <input type="text" name="services" class="form-input" placeholder="Dise√±o ¬∑ Moda ¬∑ Branding">
              </div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; margin-bottom: 16px; letter-spacing: 1px;">Infraestructura digital</div>

              <div class="form-group">
                <label class="form-label">Dominio</label>
                <input type="text" name="domain" class="form-input" placeholder="ejemplo.com">
              </div>
              <div class="form-group">
                <label class="form-label">Proveedor dominio</label>
                <select name="domainProvider" class="form-select">
                  <option value="">Seleccionar...</option>
                  <option value="GoDaddy">GoDaddy</option>
                  <option value="Google Domains">Google Domains</option>
                  <option value="Porkbun">Porkbun</option>
                  <option value="Namecheap">Namecheap</option>
                  <option value="Cloudflare">Cloudflare</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Renovaci√≥n dominio</label>
                <input type="date" name="domainRenewal" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Hosting</label>
                <input type="text" name="hosting" class="form-input" placeholder="Vercel, Netlify, etc">
              </div>
              <div class="form-group">
                <label class="form-label">Backend/Database</label>
                <input type="text" name="backend" class="form-input" placeholder="Supabase, Firebase, etc">
              </div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; letter-spacing: 1px;">Correos de la marca</div>
                <button type="button" onclick="addBrandEmail()" style="padding: 4px 10px; background: #1A1A1A; border: none; border-radius: 6px; color: #fff; font-size: 12px; cursor: pointer;">+ Agregar</button>
              </div>
              <div id="brand-emails-container"></div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; letter-spacing: 1px;">Redes sociales</div>
                <button type="button" onclick="addBrandSocialMedia()" style="padding: 4px 10px; background: #1A1A1A; border: none; border-radius: 6px; color: #fff; font-size: 12px; cursor: pointer;">+ Agregar</button>
              </div>
              <div id="brand-social-media-container"></div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div class="form-group">
                <label class="form-label">Notas</label>
                <textarea name="notes" class="form-textarea" placeholder="Informaci√≥n adicional sobre esta marca..."></textarea>
              </div>

              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('marca')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar marca</button>
              </div>
            </form>
          </div>
        </div>

        <div id="modal-suscripcion" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Nueva suscripci√≥n</h3>
              <button class="modal-close" onclick="closeModal('suscripcion')">√ó</button>
            </div>
            <form id="form-suscripcion" onsubmit="submitSuscripcion(event)">
              <div class="form-group">
                <label class="form-label">Nombre *</label>
                <input type="text" name="name" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Coste mensual</label>
                <input type="text" name="cost" class="form-input" placeholder="29‚Ç¨/mes">
              </div>
              <div class="form-group">
                <label class="form-label">Plan (si es free)</label>
                <input type="text" name="plan" class="form-input" placeholder="Free, Pro, etc">
              </div>
              <div class="form-group">
                <label class="form-label">URL *</label>
                <input type="url" name="url" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Asociada a</label>
                <select name="association" class="form-select" id="suscripcion-association">
                  <option value="">Ninguna</option>
                  <optgroup label="Empresas"></optgroup>
                  <optgroup label="Marcas"></optgroup>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">D√≠a de renovaci√≥n</label>
                <input type="number" name="renewalDay" class="form-input" min="1" max="31" placeholder="18">
              </div>
              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('suscripcion')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar</button>
              </div>
            </form>
          </div>
        </div>

        <div id="modal-credencial" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Nueva credencial</h3>
              <button class="modal-close" onclick="closeModal('credencial')">√ó</button>
            </div>
            <form id="form-credencial" onsubmit="submitCredencial(event)">
              <div class="form-group">
                <label class="form-label">Servicio *</label>
                <input type="text" name="service" class="form-input" required placeholder="Instagram, Stripe, etc">
              </div>
              <div class="form-group">
                <label class="form-label">Usuario</label>
                <input type="text" name="username" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Password *</label>
                <input type="text" name="password" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Categor√≠a</label>
                <select name="category" class="form-select">
                  <option value="Social Media">Social Media</option>
                  <option value="Email">Email</option>
                  <option value="Pagos">Pagos</option>
                  <option value="Tech">Tech</option>
                  <option value="Dominios">Dominios</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Asociada a</label>
                <select name="association" class="form-select" id="credencial-association">
                  <option value="">Ninguna</option>
                  <optgroup label="Empresas"></optgroup>
                  <optgroup label="Marcas"></optgroup>
                </select>
              </div>
              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('credencial')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar</button>
              </div>
            </form>
          </div>
        </div>

        <div id="modal-tarea" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Nueva tarea</h3>
              <button class="modal-close" onclick="closeModal('tarea')">√ó</button>
            </div>
            <form id="form-tarea" onsubmit="submitTarea(event)">
              <div class="form-group">
                <label class="form-label">Descripci√≥n *</label>
                <input type="text" name="description" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Fecha</label>
                <input type="date" name="date" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Asociada a</label>
                <select name="association" class="form-select" id="tarea-association">
                  <option value="">Ninguna</option>
                  <optgroup label="Empresas"></optgroup>
                  <optgroup label="Marcas"></optgroup>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Notas</label>
                <textarea name="notes" class="form-textarea"></textarea>
              </div>
              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('tarea')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar</button>
              </div>
            </form>
          </div>
        </div>

        <div id="modal-memoria" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Nueva nota - Memoria Contable</h3>
              <button class="modal-close" onclick="closeModal('memoria')">√ó</button>
            </div>
            <form id="form-memoria" onsubmit="submitMemoria(event)">
              <input type="hidden" name="companyId" id="memoria-company-id">
              <div class="form-group">
                <label class="form-label">Tipo *</label>
                <select name="type" class="form-select" required>
                  <option value="Nota">Nota</option>
                  <option value="Cambio Contable">Cambio Contable</option>
                  <option value="Decisi√≥n">Decisi√≥n</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">T√≠tulo *</label>
                <input type="text" name="title" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Contenido *</label>
                <textarea name="content" class="form-textarea" required></textarea>
              </div>
              <div class="form-group">
                <label class="form-label">Fecha</label>
                <input type="date" name="date" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Referencia</label>
                <input type="text" name="ref" class="form-input" placeholder="Ej: Aportaci√≥n capital, Ep√≠grafes...">
              </div>
              <div class="form-group">
                <label class="form-label">Tags (separados por comas)</label>
                <input type="text" name="tags" class="form-input" placeholder="importante, revisar contabilidad">
              </div>
              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('memoria')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar</button>
              </div>
            </form>
          </div>
        </div>

        <div id="modal-documento" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Nuevo documento</h3>
              <button class="modal-close" onclick="closeModal('documento')">√ó</button>
            </div>
            <form id="form-documento" onsubmit="submitDocumento(event)">
              <div class="form-group">
                <label class="form-label">Nombre *</label>
                <input type="text" name="name" class="form-input" required placeholder="Estatutos, Contrato...">
              </div>
              <div class="form-group">
                <label class="form-label">Tipo</label>
                <select name="type" class="form-select">
                  <option value="PDF">PDF</option>
                  <option value="Word">Word</option>
                  <option value="Excel">Excel</option>
                  <option value="Imagen">Imagen</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">URL / Link *</label>
                <input type="url" name="url" class="form-input" required placeholder="https://drive.google.com/...">
                <div style="font-size: 11px; color: #666; margin-top: 4px;">Link de Drive, Dropbox, Notion, etc</div>
              </div>
              <div class="form-group">
                <label class="form-label">Plataforma</label>
                <select name="platform" class="form-select">
                  <option value="Google Drive">Google Drive</option>
                  <option value="Dropbox">Dropbox</option>
                  <option value="Notion">Notion</option>
                  <option value="OneDrive">OneDrive</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Asociado a</label>
                <select name="association" class="form-select" id="documento-association">
                  <option value="">Ninguno</option>
                  <optgroup label="Empresas"></optgroup>
                  <optgroup label="Marcas"></optgroup>
                </select>
              </div>
              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('documento')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar</button>
              </div>
            </form>
          </div>
        </div>

        <div id="modal-config" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">‚öôÔ∏è Mi perfil y configuraci√≥n</h3>
              <button class="modal-close" onclick="closeModal('config')">√ó</button>
            </div>
            <form id="form-config" onsubmit="submitConfig(event)">
              
              <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; margin-bottom: 16px; letter-spacing: 1px;">Personalizaci√≥n del centro</div>
              
              <div class="form-group">
                <label class="form-label">Nombre del centro *</label>
                <input type="text" name="centerName" id="config-center-name" class="form-input" required placeholder="FGD VII ‚Äî Control Center">
              </div>
              <div class="form-group">
                <label class="form-label">Subt√≠tulo</label>
                <input type="text" name="centerSubtitle" id="config-center-subtitle" class="form-input" placeholder="Tu HQ completo">
              </div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: #666; margin-bottom: 16px; letter-spacing: 1px;">Datos personales</div>
              
              <div class="form-group">
                <label class="form-label">Tu nombre *</label>
                <input type="text" name="userName" id="config-user-name" class="form-input" required placeholder="Fiorella Giselle Difortuna">
              </div>
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" name="userEmail" id="config-user-email" class="form-input" placeholder="fiorella@ricovidarte.com">
              </div>
              <div class="form-group">
                <label class="form-label">Tel√©fono</label>
                <input type="tel" name="userPhone" id="config-user-phone" class="form-input" placeholder="+34 600 123 456">
              </div>
              <div class="form-group">
                <label class="form-label">Ubicaci√≥n</label>
                <input type="text" name="userLocation" id="config-user-location" class="form-input" placeholder="Barcelona, Espa√±a">
              </div>

              <div style="height: 1px; background: #1A1A1A; margin: 24px 0;"></div>

              <div style="background: #1A1A1A; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                <div style="font-size: 13px; color: #888; line-height: 1.6;">
                  üí° <strong>Tip:</strong> Esta configuraci√≥n se guarda en tu navegador. Para acceder desde otros dispositivos, necesitar√°s integrar con base de datos (ver documentaci√≥n).
                </div>
              </div>

              <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('config')">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar configuraci√≥n</button>
              </div>
            </form>
          </div>
        </div>
      `;
    }

    // Transformar datos locales al formato de Supabase
    function transformToSupabase(data, type) {
      switch (type) {
        case 'company':
          return {
            id: data.id,
            name: data.name,
            legal_name: data.legalName,
            cif: data.cif,
            fiscal_address: data.fiscalAddress,
            phone: data.phone,
            email: data.email,
            tags: data.tags,
            bank_accounts: data.bankAccounts,
            emails: data.emails,
            social_media: data.socialMedia,
            notes: data.notes,
            created_at: data.createdAt
          };

        case 'brand':
          return {
            id: data.id,
            name: data.name,
            type: data.type,
            company_id: data.companyId,
            tags: data.tags,
            services: data.services,
            domain: data.domain,
            domain_provider: data.domainProvider,
            domain_renewal: data.domainRenewal,
            hosting: data.hosting,
            backend: data.backend,
            emails: data.emails,
            social_media: data.socialMedia,
            notes: data.notes,
            created_at: data.createdAt
          };

        case 'task':
          return {
            id: data.id,
            description: data.description,
            date: data.date,
            completed: data.completed,
            association: data.association,
            notes: data.notes,
            created_at: data.createdAt
          };

        case 'subscription':
          return {
            id: data.id,
            name: data.name,
            cost: data.cost,
            plan: data.plan,
            url: data.url,
            association: data.association,
            renewal_day: data.renewalDay,
            created_at: data.createdAt
          };

        case 'credential':
          return {
            id: data.id,
            service: data.service,
            username: data.username,
            email: data.email,
            password: data.password,
            category: data.category,
            association: data.association,
            created_at: data.createdAt
          };

        case 'document':
          return {
            id: data.id,
            name: data.name,
            type: data.type,
            url: data.url,
            platform: data.platform,
            association: data.association,
            created_at: data.createdAt
          };

        case 'memoria':
          return {
            id: data.id,
            company_id: data.companyId,
            type: data.type,
            title: data.title,
            content: data.content,
            date: data.date,
            ref: data.ref,
            tags: data.tags,
            created_at: data.createdAt
          };

        default:
          return data;
      }
    }

    // ============================================
    // FUNCIONES DE GUARDADO Y ELIMINACI√ìN EN SUPABASE
    // ============================================

    /**
     * Guarda o actualiza un registro en Supabase
     * @param {Object} data - Los datos a guardar
     * @param {string} table - Nombre de la tabla (companies, brands, tasks, etc.)
     * @param {string} type - Tipo de datos para transformaci√≥n (company, brand, task, etc.)
     */
    async function saveToSupabase(data, table, type) {
      if (!supabase) {
        console.warn('‚ö†Ô∏è Supabase no inicializado, guardando solo en localStorage');
        return false;
      }

      try {
        // Transformar datos al formato de Supabase
        const supabaseData = transformToSupabase(data, type);
        
        console.log(`üíæ Guardando en Supabase [${table}]:`, supabaseData);

        // Intentar hacer upsert (insertar o actualizar)
        const { data: result, error } = await supabase
          .from(table)
          .upsert(supabaseData, {
            onConflict: 'id',
            returning: 'minimal'
          });

        if (error) {
          console.error(`‚ùå Error guardando en ${table}:`, error);
          return false;
        }

        console.log(`‚úÖ Datos guardados exitosamente en ${table}`);
        return true;
      } catch (error) {
        console.error(`‚ùå Error guardando en Supabase:`, error);
        return false;
      }
    }

    /**
     * Elimina un registro de Supabase
     * @param {string} id - ID del registro a eliminar
     * @param {string} table - Nombre de la tabla
     */
    async function deleteFromSupabase(id, table) {
      if (!supabase) {
        console.warn('‚ö†Ô∏è Supabase no inicializado, eliminando solo de localStorage');
        return false;
      }

      try {
        console.log(`üóëÔ∏è Eliminando de Supabase [${table}]: ${id}`);

        const { error } = await supabase
          .from(table)
          .delete()
          .eq('id', id);

        if (error) {
          console.error(`‚ùå Error eliminando de ${table}:`, error);
          return false;
        }

        console.log(`‚úÖ Registro eliminado exitosamente de ${table}`);
        return true;
      } catch (error) {
        console.error(`‚ùå Error eliminando de Supabase:`, error);
        return false;
      }
    }

    /**
     * Carga todos los datos desde Supabase
     */
    async function loadFromSupabase() {
      if (!supabase) {
        console.warn('‚ö†Ô∏è Supabase no inicializado, cargando solo desde localStorage');
        return false;
      }

      try {
        console.log('üì• Cargando datos desde Supabase...');

        // Cargar empresas
        const { data: companiesData, error: companiesError } = await supabase
          .from('companies')
          .select('*')
          .order('created_at', { ascending: false });

        if (companiesError) {
          console.error('‚ùå Error cargando empresas:', companiesError);
        } else if (companiesData) {
          companies = companiesData.map(c => transformFromSupabase(c, 'company'));
          console.log(`‚úÖ ${companies.length} empresas cargadas`);
        }

        // Cargar marcas
        const { data: brandsData, error: brandsError } = await supabase
          .from('brands')
          .select('*')
          .order('created_at', { ascending: false });

        if (brandsError) {
          console.error('‚ùå Error cargando marcas:', brandsError);
        } else if (brandsData) {
          brands = brandsData.map(b => transformFromSupabase(b, 'brand'));
          console.log(`‚úÖ ${brands.length} marcas cargadas`);
        }

        // Cargar tareas
        const { data: tasksData, error: tasksError } = await supabase
          .from('tasks')
          .select('*')
          .order('date', { ascending: false });

        if (tasksError) {
          console.error('‚ùå Error cargando tareas:', tasksError);
        } else if (tasksData) {
          tasks = tasksData.map(t => transformFromSupabase(t, 'task'));
          console.log(`‚úÖ ${tasks.length} tareas cargadas`);
        }

        // Cargar suscripciones
        const { data: subscriptionsData, error: subscriptionsError } = await supabase
          .from('subscriptions')
          .select('*')
          .order('created_at', { ascending: false });

        if (subscriptionsError) {
          console.error('‚ùå Error cargando suscripciones:', subscriptionsError);
        } else if (subscriptionsData) {
          subscriptions = subscriptionsData.map(s => transformFromSupabase(s, 'subscription'));
          console.log(`‚úÖ ${subscriptions.length} suscripciones cargadas`);
        }

        // Cargar credenciales
        const { data: credentialsData, error: credentialsError } = await supabase
          .from('credentials')
          .select('*')
          .order('created_at', { ascending: false });

        if (credentialsError) {
          console.error('‚ùå Error cargando credenciales:', credentialsError);
        } else if (credentialsData) {
          credentials = credentialsData.map(c => transformFromSupabase(c, 'credential'));
          console.log(`‚úÖ ${credentials.length} credenciales cargadas`);
        }

        // Cargar documentos
        const { data: documentsData, error: documentsError } = await supabase
          .from('documents')
          .select('*')
          .order('created_at', { ascending: false });

        if (documentsError) {
          console.error('‚ùå Error cargando documentos:', documentsError);
        } else if (documentsData) {
          documents = documentsData.map(d => transformFromSupabase(d, 'document'));
          console.log(`‚úÖ ${documents.length} documentos cargados`);
        }

        // Cargar memoria contable
        const { data: memoriaData, error: memoriaError } = await supabase
          .from('memoria_contable')
          .select('*')
          .order('date', { ascending: false });

        if (memoriaError) {
          console.error('‚ùå Error cargando memoria contable:', memoriaError);
        } else if (memoriaData) {
          memoriaContable = memoriaData.map(m => transformFromSupabase(m, 'memoria'));
          console.log(`‚úÖ ${memoriaContable.length} notas de memoria contable cargadas`);
        }

        // Guardar tambi√©n en localStorage como respaldo
        saveData();
        
        console.log('‚úÖ Todos los datos cargados desde Supabase');
        return true;
      } catch (error) {
        console.error('‚ùå Error cargando desde Supabase:', error);
        return false;
      }
    }

    // ============================================
    // FUNCIONES CRUD PRINCIPALES
    // ============================================

    // EMPRESAS
    async function submitEmpresa(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      
      const companyData = {
        id: form.dataset.editId || 'comp_' + Date.now(),
        name: formData.get('name'),
        legalName: formData.get('legalName'),
        cif: formData.get('cif'),
        fiscalAddress: formData.get('fiscalAddress'),
        phone: formData.get('phone'),
        email: formData.get('email'),
        tags: formData.get('tags') ? formData.get('tags').split(',').map(t => t.trim()) : [],
        bankAccounts: [], // Se pueden agregar despu√©s
        emails: [], // Se pueden agregar despu√©s
        socialMedia: [], // Se pueden agregar despu√©s
        notes: formData.get('notes'),
        createdAt: new Date().toISOString()
      };

      try {
        if (form.dataset.editId) {
          // Editar empresa existente
          const index = companies.findIndex(c => c.id === form.dataset.editId);
          if (index !== -1) {
            companies[index] = { ...companies[index], ...companyData };
            
            // Guardar en Supabase si est√° habilitado
            if (supabase && SUPABASE_CONFIG.enabled) {
              await saveToSupabase(companies[index], 'companies', 'company');
            }
          }
        } else {
          // Nueva empresa
          companies.push(companyData);
          
          // Guardar en Supabase si est√° habilitado
          if (supabase && SUPABASE_CONFIG.enabled) {
            await saveToSupabase(companyData, 'companies', 'company');
          }
        }

        // Guardar en localStorage
        saveData();
        
        // Re-renderizar
        renderEmpresas();
        closeModal('empresa');
        form.reset();
        delete form.dataset.editId;
        
        console.log('‚úÖ Empresa guardada correctamente');
      } catch (error) {
        console.error('‚ùå Error guardando empresa:', error);
        alert('Error guardando empresa. Revisa la consola para m√°s detalles.');
      }
    }

    async function deleteEmpresa(id) {
      if (!confirm('¬øEst√°s seguro de que deseas eliminar esta empresa?')) return;
      
      try {
        // Eliminar de array local
        const index = companies.findIndex(c => c.id === id);
        if (index !== -1) {
          companies.splice(index, 1);
        }

        // Eliminar de Supabase si est√° habilitado
        if (supabase && SUPABASE_CONFIG.enabled) {
          await deleteFromSupabase(id, 'companies');
        }

        // Guardar en localStorage
        saveData();
        
        // Re-renderizar
        renderEmpresas();
        
        console.log('‚úÖ Empresa eliminada correctamente');
      } catch (error) {
        console.error('‚ùå Error eliminando empresa:', error);
        alert('Error eliminando empresa. Revisa la consola para m√°s detalles.');
      }
    }

    function editEmpresa(id) {
      const company = companies.find(c => c.id === id);
      if (!company) return;

      const form = document.getElementById('form-empresa');
      const modal = document.getElementById('modal-empresa');
      const title = modal.querySelector('.modal-title');
      
      // Cambiar t√≠tulo del modal
      title.textContent = 'Editar empresa';
      
      // Rellenar formulario
      form.name.value = company.name || '';
      form.legalName.value = company.legalName || '';
      form.cif.value = company.cif || '';
      form.fiscalAddress.value = company.fiscalAddress || '';
      form.phone.value = company.phone || '';
      form.email.value = company.email || '';
      form.tags.value = company.tags ? company.tags.join(', ') : '';
      form.notes.value = company.notes || '';
      
      // Marcar como edici√≥n
      form.dataset.editId = id;
      
      // Mostrar modal
      showModal('empresa');
    }

    // MARCAS
    async function submitMarca(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      
      const brandData = {
        id: form.dataset.editId || 'brand_' + Date.now(),
        name: formData.get('name'),
        type: formData.get('type'),
        companyId: formData.get('companyId'),
        tags: formData.get('tags') ? formData.get('tags').split(',').map(t => t.trim()) : [],
        services: formData.get('services'),
        domain: formData.get('domain'),
        domainProvider: formData.get('domainProvider'),
        domainRenewal: formData.get('domainRenewal'),
        hosting: formData.get('hosting'),
        backend: formData.get('backend'),
        emails: [], // Se pueden agregar despu√©s
        socialMedia: [], // Se pueden agregar despu√©s
        notes: formData.get('notes'),
        createdAt: new Date().toISOString()
      };

      try {
        if (form.dataset.editId) {
          // Editar marca existente
          const index = brands.findIndex(b => b.id === form.dataset.editId);
          if (index !== -1) {
            brands[index] = { ...brands[index], ...brandData };
            
            // Guardar en Supabase si est√° habilitado
            if (supabase && SUPABASE_CONFIG.enabled) {
              await saveToSupabase(brands[index], 'brands', 'brand');
            }
          }
        } else {
          // Nueva marca
          brands.push(brandData);
          
          // Guardar en Supabase si est√° habilitado
          if (supabase && SUPABASE_CONFIG.enabled) {
            await saveToSupabase(brandData, 'brands', 'brand');
          }
        }

        // Guardar en localStorage
        saveData();
        
        // Re-renderizar
        renderMarcas();
        closeModal('marca');
        form.reset();
        delete form.dataset.editId;
        
        console.log('‚úÖ Marca guardada correctamente');
      } catch (error) {
        console.error('‚ùå Error guardando marca:', error);
        alert('Error guardando marca. Revisa la consola para m√°s detalles.');
      }
    }

    async function deleteMarca(id) {
      if (!confirm('¬øEst√°s seguro de que deseas eliminar esta marca?')) return;
      
      try {
        // Eliminar de array local
        const index = brands.findIndex(b => b.id === id);
        if (index !== -1) {
          brands.splice(index, 1);
        }

        // Eliminar de Supabase si est√° habilitado
        if (supabase && SUPABASE_CONFIG.enabled) {
          await deleteFromSupabase(id, 'brands');
        }

        // Guardar en localStorage
        saveData();
        
        // Re-renderizar
        renderMarcas();
        
        console.log('‚úÖ Marca eliminada correctamente');
      } catch (error) {
        console.error('‚ùå Error eliminando marca:', error);
        alert('Error eliminando marca. Revisa la consola para m√°s detalles.');
      }
    }

    function editMarca(id) {
      const brand = brands.find(b => b.id === id);
      if (!brand) return;

      const form = document.getElementById('form-marca');
      const modal = document.getElementById('modal-marca');
      const title = modal.querySelector('.modal-title');
      
      // Cambiar t√≠tulo del modal
      title.textContent = 'Editar marca';
      
      // Rellenar formulario
      form.name.value = brand.name || '';
      form.type.value = brand.type || '';
      form.tags.value = brand.tags ? brand.tags.join(', ') : '';
      form.services.value = brand.services || '';
      form.domain.value = brand.domain || '';
      form.domainProvider.value = brand.domainProvider || '';
      form.domainRenewal.value = brand.domainRenewal || '';
      form.hosting.value = brand.hosting || '';
      form.backend.value = brand.backend || '';
      form.notes.value = brand.notes || '';
      
      // Poblar select de empresa
      const companySelect = form.companyId;
      companySelect.innerHTML = '<option value="">Seleccionar empresa...</option>';
      companies.forEach(company => {
        const option = document.createElement('option');
        option.value = company.id;
        option.textContent = company.name;
        if (brand.companyId === company.id) {
          option.selected = true;
        }
        companySelect.appendChild(option);
      });
      
      // Marcar como edici√≥n
      form.dataset.editId = id;
      
      // Mostrar modal
      showModal('marca');
    }

    // TAREAS
    async function submitTarea(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      
      const taskData = {
        id: form.dataset.editId || 'task_' + Date.now(),
        description: formData.get('description'),
        date: formData.get('date'),
        completed: false,
        association: formData.get('association'),
        notes: formData.get('notes'),
        createdAt: new Date().toISOString()
      };

      try {
        if (form.dataset.editId) {
          // Editar tarea existente
          const index = tasks.findIndex(t => t.id === form.dataset.editId);
          if (index !== -1) {
            tasks[index] = { ...tasks[index], ...taskData, completed: tasks[index].completed };
            
            // Guardar en Supabase si est√° habilitado
            if (supabase && SUPABASE_CONFIG.enabled) {
              await saveToSupabase(tasks[index], 'tasks', 'task');
            }
          }
        } else {
          // Nueva tarea
          tasks.push(taskData);
          
          // Guardar en Supabase si est√° habilitado
          if (supabase && SUPABASE_CONFIG.enabled) {
            await saveToSupabase(taskData, 'tasks', 'task');
          }
        }

        // Guardar en localStorage
        saveData();
        
        // Re-renderizar
        renderTareas();
        renderDashboard();
        closeModal('tarea');
        form.reset();
        delete form.dataset.editId;
        
        console.log('‚úÖ Tarea guardada correctamente');
      } catch (error) {
        console.error('‚ùå Error guardando tarea:', error);
        alert('Error guardando tarea. Revisa la consola para m√°s detalles.');
      }
    }

    // SUSCRIPCIONES
    async function submitSuscripcion(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      
      const subscriptionData = {
        id: form.dataset.editId || 'sub_' + Date.now(),
        name: formData.get('name'),
        cost: formData.get('cost'),
        plan: formData.get('plan'),
        url: formData.get('url'),
        association: formData.get('association'),
        renewalDay: formData.get('renewalDay'),
        createdAt: new Date().toISOString()
      };

      try {
        if (form.dataset.editId) {
          // Editar suscripci√≥n existente
          const index = subscriptions.findIndex(s => s.id === form.dataset.editId);
          if (index !== -1) {
            subscriptions[index] = { ...subscriptions[index], ...subscriptionData };
            
            if (supabase && SUPABASE_CONFIG.enabled) {
              await saveToSupabase(subscriptions[index], 'subscriptions', 'subscription');
            }
          }
        } else {
          // Nueva suscripci√≥n
          subscriptions.push(subscriptionData);
          
          if (supabase && SUPABASE_CONFIG.enabled) {
            await saveToSupabase(subscriptionData, 'subscriptions', 'subscription');
          }
        }

        saveData();
        renderSuscripciones();
        closeModal('suscripcion');
        form.reset();
        delete form.dataset.editId;
        
        console.log('‚úÖ Suscripci√≥n guardada correctamente');
      } catch (error) {
        console.error('‚ùå Error guardando suscripci√≥n:', error);
        alert('Error guardando suscripci√≥n. Revisa la consola para m√°s detalles.');
      }
    }

    async function deleteSubscription(id) {
      if (!confirm('¬øEst√°s seguro de que deseas eliminar esta suscripci√≥n?')) return;
      
      try {
        const index = subscriptions.findIndex(s => s.id === id);
        if (index !== -1) {
          subscriptions.splice(index, 1);
        }

        if (supabase && SUPABASE_CONFIG.enabled) {
          await deleteFromSupabase(id, 'subscriptions');
        }

        saveData();
        renderSuscripciones();
        
        console.log('‚úÖ Suscripci√≥n eliminada correctamente');
      } catch (error) {
        console.error('‚ùå Error eliminando suscripci√≥n:', error);
        alert('Error eliminando suscripci√≥n. Revisa la consola para m√°s detalles.');
      }
    }

    // CREDENCIALES
    async function submitCredencial(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      
      const credentialData = {
        id: form.dataset.editId || 'cred_' + Date.now(),
        service: formData.get('service'),
        username: formData.get('username'),
        email: formData.get('email'),
        password: formData.get('password'),
        category: formData.get('category'),
        association: formData.get('association'),
        createdAt: new Date().toISOString()
      };

      try {
        if (form.dataset.editId) {
          // Editar credencial existente
          const index = credentials.findIndex(c => c.id === form.dataset.editId);
          if (index !== -1) {
            credentials[index] = { ...credentials[index], ...credentialData };
            
            if (supabase && SUPABASE_CONFIG.enabled) {
              await saveToSupabase(credentials[index], 'credentials', 'credential');
            }
          }
        } else {
          // Nueva credencial
          credentials.push(credentialData);
          
          if (supabase && SUPABASE_CONFIG.enabled) {
            await saveToSupabase(credentialData, 'credentials', 'credential');
          }
        }

        saveData();
        renderCredenciales();
        closeModal('credencial');
        form.reset();
        delete form.dataset.editId;
        
        console.log('‚úÖ Credencial guardada correctamente');
      } catch (error) {
        console.error('‚ùå Error guardando credencial:', error);
        alert('Error guardando credencial. Revisa la consola para m√°s detalles.');
      }
    }

    async function deleteCredential(id) {
      if (!confirm('¬øEst√°s seguro de que deseas eliminar esta credencial?')) return;
      
      try {
        const index = credentials.findIndex(c => c.id === id);
        if (index !== -1) {
          credentials.splice(index, 1);
        }

        if (supabase && SUPABASE_CONFIG.enabled) {
          await deleteFromSupabase(id, 'credentials');
        }

        saveData();
        renderCredenciales();
        
        console.log('‚úÖ Credencial eliminada correctamente');
      } catch (error) {
        console.error('‚ùå Error eliminando credencial:', error);
        alert('Error eliminando credencial. Revisa la consola para m√°s detalles.');
      }
    }

    // DOCUMENTOS
    async function submitDocumento(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      
      const documentData = {
        id: form.dataset.editId || 'doc_' + Date.now(),
        name: formData.get('name'),
        type: formData.get('type'),
        url: formData.get('url'),
        platform: formData.get('platform'),
        association: formData.get('association'),
        createdAt: new Date().toISOString()
      };

      try {
        if (form.dataset.editId) {
          // Editar documento existente
          const index = documents.findIndex(d => d.id === form.dataset.editId);
          if (index !== -1) {
            documents[index] = { ...documents[index], ...documentData };
            
            if (supabase && SUPABASE_CONFIG.enabled) {
              await saveToSupabase(documents[index], 'documents', 'document');
            }
          }
        } else {
          // Nuevo documento
          documents.push(documentData);
          
          if (supabase && SUPABASE_CONFIG.enabled) {
            await saveToSupabase(documentData, 'documents', 'document');
          }
        }

        saveData();
        renderDocumentos();
        closeModal('documento');
        form.reset();
        delete form.dataset.editId;
        
        console.log('‚úÖ Documento guardado correctamente');
      } catch (error) {
        console.error('‚ùå Error guardando documento:', error);
        alert('Error guardando documento. Revisa la consola para m√°s detalles.');
      }
    }

    async function deleteDocument(id) {
      if (!confirm('¬øEst√°s seguro de que deseas eliminar este documento?')) return;
      
      try {
        const index = documents.findIndex(d => d.id === id);
        if (index !== -1) {
          documents.splice(index, 1);
        }

        if (supabase && SUPABASE_CONFIG.enabled) {
          await deleteFromSupabase(id, 'documents');
        }

        saveData();
        renderDocumentos();
        
        console.log('‚úÖ Documento eliminado correctamente');
      } catch (error) {
        console.error('‚ùå Error eliminando documento:', error);
        alert('Error eliminando documento. Revisa la consola para m√°s detalles.');
      }
    }

    // MEMORIA CONTABLE
    async function submitMemoria(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      
      const memoriaData = {
        id: form.dataset.editId || 'mem_' + Date.now(),
        companyId: formData.get('companyId'),
        type: formData.get('type'),
        title: formData.get('title'),
        content: formData.get('content'),
        date: formData.get('date'),
        ref: formData.get('ref'),
        tags: formData.get('tags') ? formData.get('tags').split(',').map(t => t.trim()) : [],
        createdAt: new Date().toISOString()
      };

      try {
        if (form.dataset.editId) {
          // Editar memoria existente
          const index = memoriaContable.findIndex(m => m.id === form.dataset.editId);
          if (index !== -1) {
            memoriaContable[index] = { ...memoriaContable[index], ...memoriaData };
            
            if (supabase && SUPABASE_CONFIG.enabled) {
              await saveToSupabase(memoriaContable[index], 'memoria_contable', 'memoria');
            }
          }
        } else {
          // Nueva memoria
          memoriaContable.push(memoriaData);
          
          if (supabase && SUPABASE_CONFIG.enabled) {
            await saveToSupabase(memoriaData, 'memoria_contable', 'memoria');
          }
        }

        saveData();
        closeModal('memoria');
        form.reset();
        delete form.dataset.editId;
        
        // Si estamos viendo el detalle de una empresa, recargar
        const currentView = document.querySelector('.view.active');
        if (currentView && currentView.id === 'empresa-detalle') {
          const companyId = document.getElementById('memoria-company-id').value;
          if (companyId) {
            showCompanyDetail(companyId);
          }
        }
        
        console.log('‚úÖ Memoria contable guardada correctamente');
      } catch (error) {
        console.error('‚ùå Error guardando memoria contable:', error);
        alert('Error guardando memoria contable. Revisa la consola para m√°s detalles.');
      }
    }

    async function deleteMemoria(id) {
      if (!confirm('¬øEst√°s seguro de que deseas eliminar esta nota de memoria contable?')) return;
      
      try {
        const index = memoriaContable.findIndex(m => m.id === id);
        if (index !== -1) {
          memoriaContable.splice(index, 1);
        }

        if (supabase && SUPABASE_CONFIG.enabled) {
          await deleteFromSupabase(id, 'memoria_contable');
        }

        saveData();
        
        // Si estamos viendo el detalle de una empresa, recargar
        const currentView = document.querySelector('.view.active');
        if (currentView && currentView.id === 'empresa-detalle') {
          const companyId = currentView.dataset.companyId;
          if (companyId) {
            showCompanyDetail(companyId);
          }
        }
        
        console.log('‚úÖ Memoria contable eliminada correctamente');
      } catch (error) {
        console.error('‚ùå Error eliminando memoria contable:', error);
        alert('Error eliminando memoria contable. Revisa la consola para m√°s detalles.');
      }
    }

    // CONFIGURACI√ìN
    async function submitConfig(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      
      config = {
        centerName: formData.get('centerName'),
        centerSubtitle: formData.get('centerSubtitle'),
        userName: formData.get('userName'),
        userEmail: formData.get('userEmail'),
        userPhone: formData.get('userPhone'),
        userLocation: formData.get('userLocation')
      };

      try {
        // Guardar en localStorage
        localStorage.setItem('config', JSON.stringify(config));
        
        // Aplicar cambios inmediatamente
        const nameEl = document.getElementById('center-name');
        if (nameEl && config.centerName) nameEl.textContent = config.centerName;
        
        const subtitleEl = document.getElementById('center-subtitle');
        if (subtitleEl && config.centerSubtitle) subtitleEl.textContent = config.centerSubtitle;
        
        closeModal('config');
        
        alert('‚úÖ Configuraci√≥n guardada correctamente');
        console.log('‚úÖ Configuraci√≥n guardada');
      } catch (error) {
        console.error('‚ùå Error guardando configuraci√≥n:', error);
        alert('Error guardando configuraci√≥n. Revisa la consola para m√°s detalles.');
      }
    }

    // ============================================
    // FUNCIONES DE INTERFAZ DE USUARIO
    // ============================================
    
    // Funci√≥n para cambiar entre vistas
    function showView(viewName) {
      // Ocultar todas las vistas
      const views = document.querySelectorAll('.view');
      views.forEach(view => {
        view.classList.remove('active');
        view.style.display = 'none';
      });

      // Mostrar la vista seleccionada
      const targetView = document.getElementById(viewName);
      if (targetView) {
        targetView.classList.add('active');
        targetView.style.display = 'block';
      }

      // Actualizar botones de navegaci√≥n
      const navBtns = document.querySelectorAll('.nav-btn');
      navBtns.forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.view === viewName) {
          btn.classList.add('active');
        }
      });
    }

    // Funciones para manejar modales
    function openModal(modalType) {
      const modal = document.getElementById('modal-' + modalType);
      if (modal) {
        modal.style.display = 'flex';
        
        // Limpiar formulario si existe
        const form = modal.querySelector('form');
        if (form) {
          form.reset();
          delete form.dataset.editId;
        }
        
        // Actualizar t√≠tulo del modal
        const title = modal.querySelector('.modal-title');
        if (title) {
          const titles = {
            empresa: 'Nueva empresa',
            marca: 'Nueva marca',
            tarea: 'Nueva tarea',
            suscripcion: 'Nueva suscripci√≥n',
            credencial: 'Nueva credencial',
            documento: 'Nuevo documento',
            config: 'Configuraci√≥n',
            memoria: 'Nueva memoria contable'
          };
          title.textContent = titles[modalType] || 'Modal';
        }
      }
    }

    function closeModal(modalType) {
      const modal = document.getElementById('modal-' + modalType);
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Cerrar modales al hacer clic fuera
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }

    // Funci√≥n para cargar datos desde localStorage
    function loadData() {
      try {
        companies = JSON.parse(localStorage.getItem('companies') || '[]');
        brands = JSON.parse(localStorage.getItem('brands') || '[]');
        tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
        subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');
        credentials = JSON.parse(localStorage.getItem('credentials') || '[]');
        documents = JSON.parse(localStorage.getItem('documents') || '[]');
        memoriaContable = JSON.parse(localStorage.getItem('memoriaContable') || '[]');
        console.log('üì¶ Datos cargados desde localStorage');
      } catch (error) {
        console.error('Error cargando datos:', error);
      }
    }

    // Funci√≥n para guardar datos en localStorage
    function saveData() {
      try {
        localStorage.setItem('companies', JSON.stringify(companies));
        localStorage.setItem('brands', JSON.stringify(brands));
        localStorage.setItem('tasks', JSON.stringify(tasks));
        localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
        localStorage.setItem('credentials', JSON.stringify(credentials));
        localStorage.setItem('documents', JSON.stringify(documents));
        localStorage.setItem('memoriaContable', JSON.stringify(memoriaContable));
        console.log('üíæ Datos guardados en localStorage');
      } catch (error) {
        console.error('Error guardando datos:', error);
      }
    }

    // Funci√≥n para cargar configuraci√≥n
    function loadConfig() {
      try {
        config = JSON.parse(localStorage.getItem('config') || '{}');
        
        // Aplicar configuraci√≥n si existe
        if (config.centerName) {
          const nameEl = document.getElementById('center-name');
          if (nameEl) nameEl.textContent = config.centerName;
        }
        if (config.centerSubtitle) {
          const subtitleEl = document.getElementById('center-subtitle');
          if (subtitleEl) subtitleEl.textContent = config.centerSubtitle;
        }
      } catch (error) {
        console.error('Error cargando configuraci√≥n:', error);
      }
    }

    // Funciones b√°sicas de CRUD para tareas
    function toggleTask(id) {
      const task = tasks.find(t => t.id === id);
      if (task) {
        task.completed = !task.completed;
        saveData();
        renderTareas();
        renderDashboard();
      }
    }

    function deleteTask(id) {
      if (confirm('¬øEst√°s seguro de que deseas eliminar esta tarea?')) {
        tasks = tasks.filter(t => t.id !== id);
        saveData();
        renderTareas();
        renderDashboard();
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('Credencial copiada al portapapeles');
      }).catch(() => {
        // Fallback para navegadores antiguos
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Credencial copiada al portapapeles');
      });
    }

    // Funci√≥n de b√∫squeda global
    function globalSearch(query) {
      const searchResults = document.getElementById('search-results');
      if (!searchResults) return;

      if (!query.trim()) {
        searchResults.style.display = 'none';
        return;
      }

      const results = [];
      const searchTerm = query.toLowerCase();

      // Buscar en empresas
      companies.forEach(company => {
        if (company.name?.toLowerCase().includes(searchTerm) || 
            company.legalName?.toLowerCase().includes(searchTerm) ||
            company.cif?.toLowerCase().includes(searchTerm)) {
          results.push({
            type: 'Empresa',
            title: company.name,
            subtitle: company.legalName || company.cif,
            action: () => { showView('empresas'); searchResults.style.display = 'none'; }
          });
        }
      });

      // Buscar en marcas
      brands.forEach(brand => {
        if (brand.name?.toLowerCase().includes(searchTerm) || 
            brand.domain?.toLowerCase().includes(searchTerm)) {
          results.push({
            type: 'Marca',
            title: brand.name,
            subtitle: brand.domain || brand.type,
            action: () => { showView('marcas'); searchResults.style.display = 'none'; }
          });
        }
      });

      // Buscar en tareas
      tasks.forEach(task => {
        if (task.description?.toLowerCase().includes(searchTerm)) {
          results.push({
            type: 'Tarea',
            title: task.description,
            subtitle: task.date || 'Sin fecha',
            action: () => { showView('tareas'); searchResults.style.display = 'none'; }
          });
        }
      });

      if (results.length > 0) {
        searchResults.innerHTML = results.map(result => `
          <div class="search-result" onclick="handleSearchResult('${result.type}', '${result.title}')" style="padding: 12px; border-bottom: 1px solid #1A1A1A; cursor: pointer; hover:background: #1A1A1A;">
            <div style="font-size: 14px; font-weight: 500;">${result.title}</div>
            <div style="font-size: 12px; color: #888;">${result.type} ‚Ä¢ ${result.subtitle}</div>
          </div>
        `).join('');
        searchResults.style.display = 'block';
      } else {
        searchResults.innerHTML = '<div style="padding: 12px; color: #888; text-align: center;">No se encontraron resultados</div>';
        searchResults.style.display = 'block';
      }
    }

    function handleSearchResult(type, title) {
      const searchResults = document.getElementById('search-results');
      if (searchResults) {
        searchResults.style.display = 'none';
      }
      
      // Limpiar b√∫squeda
      const searchInput = document.getElementById('global-search');
      if (searchInput) {
        searchInput.value = '';
      }
      
      // Navegar a la vista correspondiente
      switch (type) {
        case 'Empresa':
          showView('empresas');
          break;
        case 'Marca':
          showView('marcas');
          break;
        case 'Tarea':
          showView('tareas');
          break;
      }
    }
  </script>
</body>
</html>
